<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9;}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;background:#334155;}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer;}
nav button:hover{background:#475569;}
.container{max-width:1200px;margin:auto;padding:15px;}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);}
.hidden{display:none;}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #cbd5e1;}
button.action{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;}
button.action:hover{opacity:.9;}
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;vertical-align:top;}
th{background:#e5e7eb;}
.grade{padding:4px 6px;border-radius:5px;color:#fff;font-weight:bold;margin:2px;display:inline-block;cursor:pointer;}
.grade:hover{opacity:.8;}
textarea{resize:none;}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>
<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="showSection('program')">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- INPUT -->
<div id="input" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
<select id="entryType">
<option value="grade">–û—Ü–µ–Ω–∫–∞</option>
<option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
<option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
</select>
<select id="entryStudent"></select>
<select id="entrySubject"></select>

<div id="gradeBox">
<input id="gradeValue" type="number" min="2" max="6" placeholder="–û—Ü–µ–Ω–∫–∞">
<input id="gradeAuthor" placeholder="–û—Ç –∫–æ–≥–æ">
<input id="gradeReason" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ">
</div>
<textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<div class="table-wrap">
<table>
<thead id="diaryHead"></thead>
<tbody id="diaryBody"></tbody>
</table>
</div>
</div>

<!-- PROGRAM -->
<div id="program" class="card hidden">
<h3>–°–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞</h3>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<table>
<thead><tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr></thead>
<tbody id="programTable"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
 apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
 authDomain: "dnevnik2-42909.firebaseapp.com",
 databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
 projectId: "dnevnik2-42909"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* STATE */
let uid=null, students={}, subjects=["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞","–ë–ï–õ"], grades={}, program={day1:[],day2:[],day3:[]};

/* UI */
window.showSection=id=>{
 if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑!");
 document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
 updateEntrySelects();
 renderDiary();
 renderProgram();
};

/* AUTH */
window.register=()=>{
 createUserWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid; initUser(); showSection('students');})
 .catch(e=>alert(e.message));
};
window.login=()=>{
 signInWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid; loadUser(); showSection('students');})
 .catch(e=>alert(e.message));
};
window.logout=()=>signOut(auth).then(()=>location.reload());

/* INIT / LOAD */
function initUser(){
 students={}; grades={}; program={day1:Array(6).fill(""), day2:Array(6).fill(""), day3:Array(6).fill("")};
 saveUser();
}
function loadUser(){
 get(ref(db,"diary/"+uid)).then(s=>{
   if(s.exists()){
     const data=s.val();
     students=data.students||{};
     subjects=data.subjects||subjects;
     grades=data.grades||{};
     program=data.program||{day1:Array(6).fill(""), day2:Array(6).fill(""), day3:Array(6).fill("")};
   } else initUser();
 });
}

/* SAVE */
function saveUser(){
 set(ref(db,"diary/"+uid),{students,subjects,grades,program});
}

/* STUDENTS */
window.addStudent=()=>{
 if(!studentName.value) return;
 if(!students[studentName.value]) students[studentName.value]={};
 studentName.value="";
 saveUser(); renderDiary(); updateEntrySelects();
};
function updateEntrySelects(){
 entryStudent.innerHTML=Object.keys(students).map(s=>`<option>${s}</option>`).join("");
 entrySubject.innerHTML=subjects.map(s=>`<option>${s}</option>`).join("");
}

/* INPUT */
entryType.onchange=()=>{
 gradeBox.classList.toggle("hidden", entryType.value!=="grade");
 textValue.classList.toggle("hidden", entryType.value==="grade");
};
window.addEntry=()=>{
 const st=entryStudent.value, sb=entrySubject.value;
 if(!students[st]) return alert("–ù—è–º–∞ —Ç–∞–∫—ä–≤ —É—á–µ–Ω–∏–∫");
 if(entryType.value==="grade"){
   const val=+gradeValue.value;
   if(!grades[st]) grades[st]={};
   if(!grades[st][sb]) grades[st][sb]=[];
   grades[st][sb].push({value:val, author:gradeAuthor.value, reason:gradeReason.value});
   gradeValue.value=gradeAuthor.value=gradeReason.value="";
 } else if(entryType.value==="remark"){
   if(!grades[st]) grades[st]={};
   if(!grades[st][sb]) grades[st][sb]=[];
   grades[st][sb].push({remark:textValue.value});
   textValue.value="";
 } else {
   if(!grades[st]) grades[st]={};
   if(!grades[st][sb]) grades[st][sb]=[];
   grades[st][sb].push({praise:textValue.value});
   textValue.value="";
 }
 saveUser(); renderDiary();
};

/* DIARY */
function renderDiary(){
 let h="<tr><th>–£—á–µ–Ω–∏–∫</th>";
 subjects.forEach(s=>h+=`<th>${s}<br>–û—Ü–µ–Ω–∫–∏ / –ó–∞–±–µ–ª–µ–∂–∫–∏ / –ü–æ—Ö–≤–∞–ª–∏</th>`);
 diaryHead.innerHTML=h+"</tr>";

 let b="";
 for(let st in students){
   b+="<tr><td>"+st+"</td>";
   subjects.forEach(sb=>{
     let cell="";
     (grades[st]?.[sb]||[]).forEach((g,i)=>{
       if(g.value) cell+=`<span class="grade" style="background:${{2:"#dc2626",3:"#ea580c",4:"#ca8a04",5:"#2563eb",6:"#16a34a"}[g.value]||"#64748b"}" onclick="deleteGrade('${st}','${sb}',${i})">${g.value} (${g.author || ""}:${g.reason || ""})</span><br>`;
       if(g.remark) cell+=`<span style="color:#111">${g.remark}</span><br>`;
       if(g.praise) cell+=`<span style="color:#16a34a">${g.praise}</span><br>`;
     });
     b+="<td>"+cell+"</td>";
   });
   b+="</tr>";
 }
 diaryBody.innerHTML=b;
}
window.deleteGrade=(st,sb,i)=>{
 if(confirm("–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ —Ç–∞–∑–∏ –æ—Ü–µ–Ω–∫–∞?")){
   grades[st][sb].splice(i,1);
   saveUser(); renderDiary();
 }
};

/* PROGRAM */
window.generateProgram=()=>{
 const allSubjects=subjects.slice();
 program={day1:[],day2:[],day3:[]};
 for(let d=1;d<=3;d++){
   let dayArr=[];
   for(let h=0;h<6;h++){
     let sub=allSubjects[Math.floor(Math.random()*allSubjects.length)];
     dayArr.push(sub);
   }
   program[`day${d}`]=dayArr;
 }
 saveUser(); renderProgram();
};
function renderProgram(){
 if(!program.day1) return;
 let table="";
 for(let i=0;i<6;i++){
   table+="<tr><td>"+(i+1)+"</td>";
   for(let d=1;d<=3;d++){
     table+=`<td contenteditable="true" onblur="saveProgram()">${program[`day${d}`][i]}</td>`;
   }
   table+="</tr>";
 }
 programTable.innerHTML=table;
}
window.saveProgram=()=>{
 for(let i=0;i<6;i++){
   for(let d=1;d<=3;d++){
     const val=programTable.rows[i].cells[d].innerText;
     program[`day${d}`][i]=val;
   }
 }
 saveUser();
}
showSection("auth");
</script>
</body>
</html>


