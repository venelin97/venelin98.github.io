<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #cbd5e1}
button.action{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer}
button.action:hover{opacity:.9}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center;vertical-align:top}
th{background:#e5e7eb}
.grade{padding:4px 7px;border-radius:5px;color:#fff;font-weight:bold;cursor:pointer;display:inline-block;margin:2px}
.section-title{margin-top:15px;margin-bottom:5px;font-weight:bold}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>
<nav>
<button onclick="showSection('studentsSection')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('subjectsSection')">–ü—Ä–µ–¥–º–µ—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="showSection('diarySection')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="authSection" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="loginUser()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="studentsSection" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- SUBJECTS + PROGRAM -->
<div id="subjectsSection" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏</h3>
<input id="subjectName" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" min="1" placeholder="–ß–∞—Å–æ–≤–µ –Ω–∞ —Å–µ–¥–º–∏—Ü–∞">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–µ–¥–º–µ—Ç</button>
<ul id="subjectList"></ul>

<div class="section-title">–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Å–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ (3 –¥–Ω–∏, 6 —á–∞—Å–∞ –Ω–∞ –¥–µ–Ω)</div>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<table id="programTable"></table>
</div>

<!-- DIARY -->
<div id="diarySection" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<select id="entryStudent"></select>
<select id="entrySubject"></select>
<select id="entryType">
<option value="grade">–û—Ü–µ–Ω–∫–∞</option>
<option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
<option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
</select>
<input id="gradeValue" type="number" min="2" max="6" placeholder="–û—Ü–µ–Ω–∫–∞">
<input id="gradeAuthor" placeholder="–í—ä–≤–µ–¥–µ–Ω–æ –æ—Ç">
<input id="gradeReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞/—Ç–µ—Å—Ç/–¥–æ–º–∞—à–Ω–æ">
<textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
<table id="diaryTable"></table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909",
  storageBucket: "dnevnik2-42909.firebasestorage.app",
  messagingSenderId: "824393263608",
  appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ===== STATE ===== */
let currentUid = null;
let students = {};
let subjects = [];
let program = [];
let diary = {};

/* ===== UI FUNCTIONS ===== */
function showSection(id){
  if(id !== "authSection" && !currentUid){ alert("–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ!"); return;}
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  updateStudentSelect();
  updateSubjectSelect();
  renderDiary();
  renderProgram();
}

window.logout = () => signOut(auth).then(()=> location.reload());

/* ===== AUTH ===== */
window.registerUser = () => {
  const emailVal = document.getElementById('email').value.trim();
  const passVal = document.getElementById('password').value.trim();
  if(!emailVal || !passVal){ alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞"); return;}
  createUserWithEmailAndPassword(auth,emailVal,passVal)
  .then(u=>{
    currentUid=u.user.uid;
    students={}; subjects=[]; program=[]; diary={};
    saveAll();
    showSection('studentsSection');
  }).catch(e=>alert(e.message));
};

window.loginUser = () => {
  const emailVal = document.getElementById('email').value.trim();
  const passVal = document.getElementById('password').value.trim();
  if(!emailVal || !passVal){ alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞"); return;}
  signInWithEmailAndPassword(auth,emailVal,passVal)
  .then(u=>{
    currentUid = u.user.uid;
    loadAll();
    showSection('studentsSection');
  }).catch(e=>alert(e.message));
};

/* ===== DATABASE ===== */
function saveAll(){
  if(!currentUid) return;
  set(ref(db,'diary/'+currentUid), {students, subjects, program, diary});
}

function loadAll(){
  if(!currentUid) return;
  get(child(ref(db), 'diary/'+currentUid)).then(snap=>{
    if(snap.exists()){
      ({students, subjects, program, diary} = snap.val());
    }
    renderDiary();
    renderProgram();
    updateStudentSelect();
    updateSubjectSelect();
    updateSubjectList();
    updateStudentList();
  });
}

/* ===== STUDENTS ===== */
window.addStudent = () => {
  const val = document.getElementById('studentName').value.trim();
  if(!val) return;
  if(!students[val]){ students[val]={}; diary[val]={}; subjects.forEach(s=> diary[val][s]={grades:[],remarks:[],praises:[]}); }
  document.getElementById('studentName').value='';
  saveAll(); renderDiary(); updateStudentList(); updateStudentSelect();
};

function updateStudentList(){
  const ul = document.getElementById('studentList');
  ul.innerHTML='';
  for(let st in students){
    const li = document.createElement('li');
    li.textContent = st+' ';
    const btn = document.createElement('button');
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick = ()=>{
      delete students[st]; delete diary[st];
      saveAll(); renderDiary(); updateStudentList(); updateStudentSelect();
    };
    li.appendChild(btn);
    ul.appendChild(li);
  }
}

function updateStudentSelect(){
  const sel = document.getElementById('entryStudent');
  sel.innerHTML = Object.keys(students).map(s=>`<option>${s}</option>`).join('');
}

/* ===== SUBJECTS & PROGRAM ===== */
window.addSubject = () => {
  const name = document.getElementById('subjectName').value.trim();
  const hours = parseInt(document.getElementById('subjectHours').value);
  if(!name || !hours){ alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ –∏ —á–∞—Å–æ–≤–µ"); return;}
  const existing = subjects.find(s=>s.name===name);
  if(existing) existing.hours = hours;
  else subjects.push({name,hours});
  // update diary structure
  for(let st in students){
    if(!diary[st][name]) diary[st][name]={grades:[],remarks:[],praises:[]};
  }
  document.getElementById('subjectName').value='';
  document.getElementById('subjectHours').value='';
  saveAll(); renderDiary(); updateSubjectSelect(); updateSubjectList();
};

function updateSubjectSelect(){
  const sel = document.getElementById('entrySubject');
  sel.innerHTML = subjects.map(s=>`<option>${s.name}</option>`).join('');
}

function updateSubjectList(){
  const ul = document.getElementById('subjectList');
  ul.innerHTML='';
  subjects.forEach((s,i)=>{
    const li = document.createElement('li');
    li.textContent = `${s.name} (${s.hours} —á.) `;
    const btn = document.createElement('button');
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick = ()=>{
      subjects.splice(i,1);
      for(let st in students){ delete diary[st][s.name]; }
      saveAll(); renderDiary(); updateSubjectSelect(); updateSubjectList();
    };
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

/* ===== PROGRAM GENERATION ===== */
window.generateProgram = ()=>{
  const totalHours = subjects.reduce((a,b)=>a+b.hours,0);
  if(totalHours!==18){ alert("–ß–∞—Å–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ —Ç–æ—á–Ω–æ 18"); return;}
  // reset program
  program=[];
  for(let d=0; d<3; d++){
    program[d]=[];
    let tempSubjects=[];
    subjects.forEach(s=>{ for(let i=0;i<s.hours;i++) tempSubjects.push(s.name); });
    // shuffle tempSubjects
    tempSubjects.sort(()=>Math.random()-0.5);
    program[d]=tempSubjects.slice(0,6);
  }
  saveAll();
  renderProgram();
};

function renderProgram(){
  const tbl = document.getElementById('programTable');
  tbl.innerHTML='';
  if(program.length===0) return;
  const trHead = document.createElement('tr');
  trHead.innerHTML='<th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th>';
  tbl.appendChild(trHead);
  for(let h=0; h<6; h++){
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${h+1}</td>`+
      `<td>${program[0][h]||''}</td>`+
      `<td>${program[1][h]||''}</td>`+
      `<td>${program[2][h]||''}</td>`;
    tbl.appendChild(tr);
  }
}

/* ===== DIARY ===== */
document.getElementById('entryType').addEventListener('change',()=>{
  const type=document.getElementById('entryType').value;
  document.getElementById('gradeValue').classList.toggle('hidden',type!=='grade');
  document.getElementById('gradeAuthor').classList.toggle('hidden',type!=='grade');
  document.getElementById('gradeReason').classList.toggle('hidden',type!=='grade');
  document.getElementById('textValue').classList.toggle('hidden',type==='grade');
});

window.addEntry = ()=>{
  const student = document.getElementById('entryStudent').value;
  const subject = document.getElementById('entrySubject').value;
  const type = document.getElementById('entryType').value;
  if(!student || !subject) return;
  if(type==='grade'){
    const val = parseInt(document.getElementById('gradeValue').value);
    const author = document.getElementById('gradeAuthor').value;
    const reason = document.getElementById('gradeReason').value;
    if(!val || !author || !reason){ alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞ –∑–∞ –æ—Ü–µ–Ω–∫–∞"); return;}
    diary[student][subject].grades.push({value:val,author,reason});
    document.getElementById('gradeValue').value='';
    document.getElementById('gradeAuthor').value='';
    document.getElementById('gradeReason').value='';
  } else if(type==='remark'){
    const txt=document.getElementById('textValue').value.trim();
    if(!txt) return;
    diary[student][subject].remarks.push(txt);
    document.getElementById('textValue').value='';
  } else if(type==='praise'){
    const txt=document.getElementById('textValue').value.trim();
    if(!txt) return;
    diary[student][subject].praises.push(txt);
    document.getElementById('textValue').value='';
  }
  saveAll();
  renderDiary();
};

function renderDiary(){
  const tbl=document.getElementById('diaryTable');
  tbl.innerHTML='';
  if(!subjects.length || !Object.keys(students).length) return;
  // header row
  const trHead = document.createElement('tr');
  trHead.innerHTML='<th>–£—á–µ–Ω–∏–∫</th>';
  subjects.forEach(s=>{
    trHead.innerHTML += `<th colspan="3">${s.name}</th>`;
  });
  tbl.appendChild(trHead);
  // sub-header row
  const trSub = document.createElement('tr');
  trSub.innerHTML='<th></th>';
  subjects.forEach(s=>{
    trSub.innerHTML += '<th>–û—Ü–µ–Ω–∫–∏</th><th>–ü–æ—Ö–≤–∞–ª–∏</th><th>–ó–∞–±–µ–ª–µ–∂–∫–∏</th>';
  });
  tbl.appendChild(trSub);
  // student rows
  Object.keys(students).forEach(st=>{
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${st}</td>`;
    subjects.forEach(sub=>{
      const cell = diary[st][sub];
      const tdGrades = document.createElement('td');
      cell.grades.forEach((g,i)=>{
        const span=document.createElement('span');
        span.className='grade';
        span.textContent=g.value;
        span.title=`–û—Ç: ${g.author}\n–ü—Ä–∏—á–∏–Ω–∞: ${g.reason}`;
        span.onclick=()=>{ if(confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –æ—Ü–µ–Ω–∫–∞—Ç–∞?')){ cell.grades.splice(i,1); saveAll(); renderDiary(); } };
        tdGrades.appendChild(span);
      });
      const tdPraises=document.createElement('td');
      tdPraises.textContent=cell.praises.join("\n");
      const tdRemarks=document.createElement('td');
      tdRemarks.textContent=cell.remarks.join("\n");
      tr.appendChild(tdGrades); tr.appendChild(tdPraises); tr.appendChild(tdRemarks);
    });
    tbl.appendChild(tr);
  });
}

showSection('authSection');

</script>
</body>
</html>
