<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;background:#334155;}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer;}
nav button:hover{background:#475569;}
.container{max-width:1200px;margin:auto;padding:15px;}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);}
.hidden{display:none;}
input,select,textarea{width:100%;padding:8px;margin:4px 0;border-radius:5px;border:1px solid #cbd5e1;}
button.action{background:#2563eb;color:#fff;border:none;padding:8px;border-radius:5px;cursor:pointer;margin:2px;}
button.action:hover{opacity:.9;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center;vertical-align:top;}
th{background:#e5e7eb;}
.grade{padding:4px 6px;border-radius:5px;color:#fff;font-weight:bold;margin:2px;display:inline-block;cursor:pointer;}
.grade:hover{opacity:.8;}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏/–ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- SUBJECTS/PROGRAM -->
<div id="subjects" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏</h3>
<input id="subjectName" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" min="1" max="6" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
<ul id="subjectList"></ul>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<table>
<thead><tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr></thead>
<tbody id="programTable"></tbody>
</table>
</div>

<!-- INPUT -->
<div id="input" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
<select id="entryType">
<option value="grade">–û—Ü–µ–Ω–∫–∞</option>
<option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
<option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
</select>
<select id="entryStudent"></select>
<select id="entrySubject"></select>

<div id="gradeBox">
<input id="gradeValue" type="number" min="2" max="6" placeholder="–û—Ü–µ–Ω–∫–∞">
<input id="gradeAuthor" placeholder="–û—Ç –∫–æ–≥–æ">
<input id="gradeReason" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ">
</div>
<textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<div class="table-wrap">
<table>
<thead id="diaryHead"></thead>
<tbody id="diaryBody"></tbody>
</table>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
 apiKey: "YOUR_API_KEY",
 authDomain: "YOUR_AUTH_DOMAIN",
 databaseURL: "YOUR_DATABASE_URL",
 projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid=null, students={}, subjects=[], grades={}, program={day1:[],day2:[],day3:[]};

window.showSection=id=>{
 if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑!");
 document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
 document.getElementById(id).classList.remove('hidden');
 updateEntrySelects(); renderSubjects(); renderDiary(); renderProgram();
};

window.register=()=>{
 createUserWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid; initUser(); showSection('students');})
 .catch(e=>alert(e.message));
};

window.login=()=>{
 signInWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid; loadUser(); showSection('students');})
 .catch(e=>alert(e.message));
};

window.logout=()=>signOut(auth).then(()=>location.reload());

function initUser(){
 students={}; subjects=[]; grades={};
 program={day1:Array(6).fill(""), day2:Array(6).fill(""), day3:Array(6).fill("")};
 saveUser();
}

function loadUser(){
 get(ref(db,"diary/"+uid)).then(s=>{
   if(s.exists()){
     const data=s.val();
     students=data.students||{};
     subjects=data.subjects||[];
     grades=data.grades||{};
     program=data.program||{day1:Array(6).fill(""),day2:Array(6).fill(""),day3:Array(6).fill("")};
   } else initUser();
   renderSubjects(); renderStudentList();
});
}

function saveUser(){
 set(ref(db,"diary/"+uid),{students,subjects,grades,program});
}

/* STUDENTS */
window.addStudent=()=>{
 if(!studentName.value) return;
 if(!students[studentName.value]) students[studentName.value]={};
 studentName.value=""; saveUser(); renderStudentList(); updateEntrySelects(); renderDiary();
};

function renderStudentList(){
 studentList.innerHTML="";
 for(let s in students){
   let li=document.createElement("li");
   li.textContent=s;
   let btn=document.createElement("button"); btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
   btn.onclick=()=>{delete students[s]; saveUser(); renderStudentList(); updateEntrySelects(); renderDiary();}
   li.appendChild(btn); studentList.appendChild(li);
 }
}

/* SUBJECTS */
window.addSubject=()=>{
 const n=subjectName.value.trim();
 const h=+subjectHours.value;
 if(!n||!h) return alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ —á–∞—Å–æ–≤–µ");
 const totalHours=subjects.reduce((acc,s)=>acc+(s.hours||0),0)+h;
 if(totalHours>18) return alert("–û–±—â–∏—Ç–µ —á–∞—Å–æ–≤–µ –Ω–µ –º–æ–≥–∞—Ç –¥–∞ –Ω–∞–¥–≤–∏—à–∞–≤–∞—Ç 18");
 let exist=subjects.find(s=>s.name===n);
 if(exist){exist.hours=h;} else subjects.push({name:n,hours:h});
 subjectName.value=""; subjectHours.value=""; saveUser(); renderSubjects(); updateEntrySelects();
};

function renderSubjects(){
 subjectList.innerHTML="";
 subjects.forEach((s,i)=>{
   let li=document.createElement("li");
   li.textContent=`${s.name} (${s.hours}—á)`;
   let btn=document.createElement("button"); btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
   btn.onclick=()=>{subjects.splice(i,1); saveUser(); renderSubjects(); updateEntrySelects();}
   li.appendChild(btn); subjectList.appendChild(li);
 });
}

/* ENTRY */
function updateEntrySelects(){
 entryStudent.innerHTML=Object.keys(students).map(s=>`<option>${s}</option>`).join("");
 entrySubject.innerHTML=subjects.map(s=>`<option>${s.name}</option>`).join("");
}
entryType.onchange=()=>{gradeBox.classList.toggle("hidden",entryType.value!=="grade"); textValue.classList.toggle("hidden",entryType.value==="grade");};
window.addEntry=()=>{
 const st=entryStudent.value, sb=entrySubject.value;
 if(!students[st]) return alert("–ù—è–º–∞ —Ç–∞–∫—ä–≤ —É—á–µ–Ω–∏–∫");
 if(!grades[st]) grades[st]={};
 if(!grades[st][sb]) grades[st][sb]={grades:[],remarks:[],praises:[]};
 if(entryType.value==="grade") grades[st][sb].grades.push({value:+gradeValue.value,author:gradeAuthor.value,reason:gradeReason.value});
 else if(entryType.value==="remark") grades[st][sb].remarks.push(textValue.value);
 else grades[st][sb].praises.push(textValue.value);
 gradeValue.value=gradeAuthor.value=gradeReason.value=textValue.value="";
 saveUser(); renderDiary();
};

/* DIARY */
function renderDiary(){
 diaryHead.innerHTML="<tr><th>–£—á–µ–Ω–∏–∫</th>";
 subjects.forEach(s=>diaryHead.innerHTML+=`<th>${s.name}<div style="border-top:1px solid #000">–û—Ü–µ–Ω–∫–∏</div><div style="border-top:1px solid #000">–ó–∞–±–µ–ª–µ–∂–∫–∏</div><div style="border-top:1px solid #000">–ü–æ—Ö–≤–∞–ª–∏</div></th>`);
 diaryHead.innerHTML+="</tr>";
 diaryBody.innerHTML="";
 for(let st in students){
   let tr=document.createElement("tr");
   let td=document.createElement("td"); td.textContent=st; tr.appendChild(td);
   subjects.forEach(sb=>{
     let cell=document.createElement("td");
     let gdata=grades[st]?.[sb.name];
     if(gdata){
       gdata.grades.forEach((g,i)=>{
         let span=document.createElement("span"); span.className="grade";
         span.style.background={2:"#dc2626",3:"#ea580c",4:"#ca8a04",5:"#2563eb",6:"#16a34a"}[g.value]||"#64748b";
         span.textContent=g.value;
         span.onclick=()=>{if(confirm(`–û—Ü–µ–Ω–∫–∞: ${g.value}\n–û—Ç: ${g.author}\n–û—Å–Ω–æ–≤–∞–Ω–∏–µ: ${g.reason}\n–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?`)){gdata.grades.splice(i,1); saveUser(); renderDiary();}}
         cell.appendChild(span); cell.appendChild(document.createElement("br"));
       });
       gdata.remarks.forEach(r=>{let d=document.createElement("div"); d.textContent=r; cell.appendChild(d);});
       gdata.praises.forEach(p=>{let d=document.createElement("div"); d.textContent=p; cell.appendChild(d);});
     }
     tr.appendChild(cell);
   });
   diaryBody.appendChild(tr);
 }
}

/* PROGRAM */
window.generateProgram=()=>{
 const totalHours=subjects.reduce((acc,s)=>acc+s.hours,0);
 if(totalHours!==18) return alert("–°—É–º–∞—Ç–∞ –Ω–∞ —á–∞—Å–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ 18!");
 const allSubjects=subjects.map(s=>s.name);
 program={day1:[],day2:[],day3:[]};
 for(let d=1;d<=3;d++){
   let dayArr=[];
   for(let h=0;h<6;h++) dayArr.push(allSubjects[Math.floor(Math.random()*allSubjects.length)]);
   program[`day${d}`]=dayArr;
 }
 saveUser(); renderProgram();
};
function renderProgram(){
 if(!program.day1) return;
 programTable.innerHTML="";
 for(let i=0;i<6;i++){
   let tr=document.createElement("tr");
   let td=document.createElement("td"); td.textContent=i+1; tr.appendChild(td);
   for(let d=1;d<=3;d++){
     let tdDay=document.createElement("td");
     tdDay.contentEditable=true; tdDay.innerText=program[`day${d}`][i];
     tdDay.onblur=()=>{program[`day${d}`][i]=tdDay.innerText; saveUser();};
     tr.appendChild(tdDay);
   }
   programTable.appendChild(tr);
 }
}

showSection("auth");
</script>
</body>
</html>
