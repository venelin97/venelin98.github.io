<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}

input,select,textarea{
  width:100%;padding:10px;margin:6px 0;
  border-radius:6px;border:1px solid #cbd5e1
}
button.action{
  background:#2563eb;color:#fff;border:none;
  padding:10px;border-radius:6px;cursor:pointer
}
button.action:hover{opacity:.9}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{background:#e5e7eb}

.grade{
  display:inline-block;padding:4px 7px;
  border-radius:5px;color:#fff;
  font-weight:bold;cursor:pointer;margin:2px
}
.avg{display:block;font-size:12px;color:#000;margin-top:4px}
</style>
</head>

<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav class="hidden" id="menu">
<button onclick="show('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="show('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ & –ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="show('entry')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="show('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏</button>
<ul id="studentList"></ul>
</div>

<!-- SUBJECTS + PROGRAM -->
<div id="subjects" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏</h3>
<input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ –ø—Ä–µ–¥–º–µ—Ç</button>
<ul id="subjectList"></ul>

<h3>–ü—Ä–æ–≥—Ä–∞–º–∞ (3 –¥–Ω–∏ √ó 6 —á–∞—Å–∞)</h3>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<table id="programTable"></table>
</div>

<!-- ENTRY -->
<div id="entry" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
<select id="eStudent"></select>
<select id="eSubject"></select>
<select id="eType">
  <option value="grade">–û—Ü–µ–Ω–∫–∞</option>
  <option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
  <option value="note">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
</select>
<input id="eValue" placeholder="–û—Ü–µ–Ω–∫–∞ (2-6)">
<input id="eReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞ (—Ç–µ—Å—Ç, –î–ó‚Ä¶)">
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<table id="diaryTable"></table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import {
  getDatabase, ref, set, get, update
} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909",
  storageBucket: "dnevnik2-42909.firebasestorage.app",
  messagingSenderId: "824393263608",
  appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* STATE */
let uid=null;
let data={
  students:{},
  subjects:{},
  program:[],
  diary:{}
};

/* AUTH STATE */
onAuthStateChanged(auth,user=>{
  if(user){
    uid=user.uid;
    load();
    document.getElementById("menu").classList.remove("hidden");
    show("students");
  }else{
    uid=null;
    show("auth");
  }
});

/* AUTH */
window.register=()=>createUserWithEmailAndPassword(auth,email.value,password.value);
window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.logout=()=>signOut(auth);

/* DATA */
function save(){
  update(ref(db,"dnevnik/"+uid),data);
}
function load(){
  get(ref(db,"dnevnik/"+uid)).then(s=>{
    if(s.exists()) data=s.val();
    renderAll();
  });
}

/* UI */
window.show=id=>{
 document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
};

/* STUDENTS */
window.addStudent=()=>{
 if(!studentName.value)return;
 data.students[studentName.value]={};
 studentName.value="";
 save();renderAll();
};

/* SUBJECTS */
window.addSubject=()=>{
 const n=subjectName.value;
 const h=+subjectHours.value;
 if(!n||!h)return;
 data.subjects[n]=h;
 subjectName.value=subjectHours.value="";
 save();renderAll();
};

/* PROGRAM */
window.generateProgram=()=>{
 let total=Object.values(data.subjects).reduce((a,b)=>a+b,0);
 if(total!==18)return alert("–ß–∞—Å–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ 18");
 let pool=[];
 Object.entries(data.subjects).forEach(([s,h])=>{
  for(let i=0;i<h;i++) pool.push(s);
 });
 pool.sort(()=>Math.random()-0.5);
 data.program=[[],[],[]];
 for(let d=0;d<3;d++)for(let h=0;h<6;h++)
  data.program[d][h]=pool.pop();
 save();renderAll();
};

/* ENTRY */
window.addEntry=()=>{
 const st=eStudent.value;
 const sb=eSubject.value;
 if(!st||!sb)return;
 data.diary[st]??={};
 data.diary[st][sb]??={grades:[],praises:[],notes:[]};
 if(eType.value==="grade"){
  data.diary[st][sb].grades.push({
    value:+eValue.value,reason:eReason.value
  });
 }else if(eType.value==="praise"){
  data.diary[st][sb].praises.push(eReason.value);
 }else{
  data.diary[st][sb].notes.push(eReason.value);
 }
 eValue.value=eReason.value="";
 save();renderAll();
};

/* RENDER */
function renderAll(){
 studentList.innerHTML=Object.keys(data.students)
  .map(s=>`<li>${s}</li>`).join("");

 subjectList.innerHTML=Object.entries(data.subjects)
  .map(([s,h])=>`<li>${s} ‚Äì ${h}—á</li>`).join("");

 eStudent.innerHTML=Object.keys(data.students)
  .map(s=>`<option>${s}</option>`).join("");
 eSubject.innerHTML=Object.keys(data.subjects)
  .map(s=>`<option>${s}</option>`).join("");

 renderDiary();
 renderProgram();
}

function renderProgram(){
 programTable.innerHTML="";
 if(!data.program.length)return;
 let h="<tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr>";
 for(let i=0;i<6;i++){
  h+=`<tr><td>${i+1}</td>
   <td>${data.program[0][i]}</td>
   <td>${data.program[1][i]}</td>
   <td>${data.program[2][i]}</td></tr>`;
 }
 programTable.innerHTML=h;
}

function renderDiary(){
 let t=document.getElementById("diaryTable");
 let subs=Object.keys(data.subjects);
 if(!subs.length)return t.innerHTML="";
 let h="<tr><th>–£—á–µ–Ω–∏–∫</th>";
 subs.forEach(s=>{
  h+=`<th colspan="3">${s}</th>`;
 });
 h+="</tr><tr><th></th>";
 subs.forEach(()=>h+="<th>–û—Ü–µ–Ω–∫–∏</th><th>–ü–æ—Ö–≤–∞–ª–∏</th><th>–ó–∞–±–µ–ª–µ–∂–∫–∏</th>");
 h+="</tr>";
 let b="";
 Object.keys(data.students).forEach(st=>{
  b+=`<tr><td>${st}</td>`;
  subs.forEach(sb=>{
   let d=data.diary[st]?.[sb]||{grades:[],praises:[],notes:[]};
   let avg=d.grades.length
     ?(d.grades.reduce((a,g)=>a+g.value,0)/d.grades.length).toFixed(2)
     :"‚Äì";
   b+=`<td>${d.grades.map(g=>`<span class="grade">${g.value}</span>`).join("")}
        <div class="avg">–°—Ä–µ–¥–µ–Ω: ${avg}</div></td>
        <td>${d.praises.join("<br>")}</td>
        <td>${d.notes.join("<br>")}</td>`;
  });
  b+="</tr>";
 });
 t.innerHTML=h+b;
}
</script>

</body>
</html>
