<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #cbd5e1}
button.action{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer;margin-top:5px}
button.action:hover{opacity:.9}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
th{background:#e5e7eb}
.grade{padding:4px 7px;border-radius:5px;color:#fff;font-weight:bold}
textarea{resize:none}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="showSection('program')">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- INPUT -->
<div id="input" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
<select id="studentSelect"></select>
<select id="entryType">
  <option value="grade">–û—Ü–µ–Ω–∫–∞</option>
  <option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
  <option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
</select>
<select id="subjectSelect"></select>
<div id="gradeBox">
<input id="gradeValue" type="number" min="2" max="6" placeholder="–û—Ü–µ–Ω–∫–∞">
<input id="gradeAuthor" placeholder="–û—Ç –∫–æ–≥–æ">
<input id="gradeReason" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ">
</div>
<textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<div class="table-wrap">
<table>
<thead id="diaryHead"></thead>
<tbody id="diaryBody"></tbody>
</table>
</div>
</div>

<!-- PROGRAM -->
<div id="program" class="card hidden">
<h3>–°–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞</h3>
<input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏/–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–µ–¥–º–µ—Ç</button>
<div class="table-wrap">
<table>
<thead>
<tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr>
</thead>
<tbody id="programTable"></tbody>
</table>
</div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
 apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
 authDomain: "dnevnik2-42909.firebaseapp.com",
 databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
 projectId: "dnevnik2-42909"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// ===== STATE =====
let uid = null;
let students = {};
let subjects = [];
let program = {};
let diary = {};

// ===== UI =====
window.showSection = id=>{
  if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑!");
  document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  renderAll();
};

// ===== AUTH =====
window.register = ()=>{
 createUserWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{
   uid=u.user.uid;
   students={};
   subjects=[];
   program={day1:[],day2:[],day3:[]};
   diary={};
   saveAll();
   showSection('students');
 })
 .catch(e=>alert(e.message));
};

window.login = ()=>{
 signInWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{
   uid=u.user.uid;
   loadAll();
   showSection('students');
 })
 .catch(e=>alert(e.message));
};

window.logout = ()=>signOut(auth).then(()=>location.reload());

// ===== DATABASE =====
function saveAll(){
 if(!uid) return;
 set(ref(db,"diary/"+uid),{students,subjects,program,diary});
}
function loadAll(){
 if(!uid) return;
 get(child(ref(db),"diary/"+uid)).then(s=>{
   if(s.exists()){
     students=s.val().students||{};
     subjects=s.val().subjects||[];
     program=s.val().program||{day1:[],day2:[],day3:[]};
     diary=s.val().diary||{};
   }
   renderAll();
 });
}

// ===== STUDENTS =====
window.addStudent = ()=>{
 let n=studentName.value.trim();
 if(!n) return;
 if(!students[n]) students[n]={};
 studentName.value="";
 saveAll();
 renderAll();
};

// ===== SUBJECTS =====
window.addSubject = ()=>{
 let n=subjectName.value.trim();
 let h=+subjectHours.value;
 if(!n || !h) return;
 let existing = subjects.find(s=>s.name===n);
 if(existing) existing.hours=h;
 else subjects.push({name:n,hours:h});
 generateProgram();
 subjectName.value="";
 subjectHours.value="";
 saveAll();
 renderAll();
};

// ===== PROGRAM =====
function generateProgram(){
 let hoursArray=[];
 subjects.forEach(s=>{
   for(let i=0;i<s.hours;i++) hoursArray.push(s.name);
 });
 // –°–ª—É—á–∞–π–Ω–æ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–Ω–∏
 program={day1:[],day2:[],day3:[]};
 for(let i=0;i<6;i++) program.day1[i]=hoursArray.splice(Math.floor(Math.random()*hoursArray.length),1)[0]||"";
 for(let i=0;i<6;i++) program.day2[i]=hoursArray.splice(Math.floor(Math.random()*hoursArray.length),1)[0]||"";
 for(let i=0;i<6;i++) program.day3[i]=hoursArray.splice(Math.floor(Math.random()*hoursArray.length),1)[0]||"";
 saveAll();
}

// ===== INPUT =====
entryType.onchange=()=>{
  gradeBox.classList.toggle("hidden",entryType.value!=="grade");
  textValue.classList.toggle("hidden",entryType.value==="grade");
};

window.addEntry = ()=>{
 let st=studentSelect.value;
 let sb=subjectSelect.value;
 if(!st || !sb) return;
 if(!diary[st]) diary[st]={};
 if(!diary[st][sb]) diary[st][sb]={grades:[],remarks:[],praises:[]};
 if(entryType.value==="grade"){
   diary[st][sb].grades.push({value:+gradeValue.value,author:gradeAuthor.value,reason:gradeReason.value});
   gradeValue.value=""; gradeAuthor.value=""; gradeReason.value="";
 } else if(entryType.value==="remark"){
   diary[st][sb].remarks.push(textValue.value); textValue.value="";
 } else{
   diary[st][sb].praises.push(textValue.value); textValue.value="";
 }
 saveAll();
 renderAll();
};

// ===== RENDER =====
function renderAll(){
 // Students
 studentList.innerHTML=Object.keys(students).map(s=>`<li>${s}</li>`).join("");
 studentSelect.innerHTML=Object.keys(students).map(s=>`<option>${s}</option>`).join("");
 subjectSelect.innerHTML=subjects.map(s=>`<option>${s.name}</option>`).join("");

 // Diary
 diaryHead.innerHTML="<tr><th>–£—á–µ–Ω–∏–∫</th>"+subjects.map(s=>`<th>${s.name}</th>`).join("")+"</tr>";
 diaryBody.innerHTML=Object.keys(students).map(st=>{
   return "<tr><td>"+st+"</td>"+subjects.map(sb=>{
     let d=diary[st][sb];
     let gradesHTML = d?.grades.map(g=>`<span class="grade" style="background:${{2:"#dc2626",3:"#ea580c",4:"#ca8a04",5:"#2563eb",6:"#16a34a"}[g.value]||"#64748b"}">${g.value}</span>`).join("")||"-";
     let remarksHTML=d?.remarks.join("<br>")||"-";
     let praisesHTML=d?.praises.join("<br>")||"-";
     return `<td>–û—Ü: ${gradesHTML}<br>–ó: ${remarksHTML}<br>–ü: ${praisesHTML}</td>`;
   }).join("")+"</tr>";
 }).join("");

 // Program
 let tableHTML="";
for(let i=0;i<6;i++){
  tableHTML+=`<tr><td>${i+1}</td><td contenteditable="true">${program.day1[i]||""}</td><td contenteditable="true">${program.day2[i]||""}</td><td contenteditable="true">${program.day3[i]||""}</td></tr>`;
}
programTable.innerHTML=tableHTML;
}

showSection("auth");
</script>

</body>
</html>
