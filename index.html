<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>

<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff}
nav button:hover{background:#475569}
.container{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}

input,select{
 width:100%;padding:10px;margin:6px 0;
 border-radius:6px;border:1px solid #cbd5e1
}
button.action{
 background:#2563eb;color:#fff;border:none;
 padding:10px;border-radius:6px;cursor:pointer
}
button.danger{
 background:#dc2626;color:#fff;border:none;
 padding:4px 8px;border-radius:5px;margin-left:6px
}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center}
th{background:#e5e7eb}

.grade{
 display:inline-block;padding:4px 7px;
 border-radius:5px;color:#fff;
 font-weight:bold;margin:2px;background:#2563eb
}
.avg{display:block;font-size:12px;margin-top:4px}
</style>
</head>

<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav id="menu" class="hidden">
<button onclick="show('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="show('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ & –ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="show('entry')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="show('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" autocomplete="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" autocomplete="current-password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏</button>
<ul id="studentList"></ul>
</div>

<div id="subjects" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏</h3>
<input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏</button>
<ul id="subjectList"></ul>

<h3>–ü—Ä–æ–≥—Ä–∞–º–∞ (3√ó6)</h3>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π</button>
<table id="programTable"></table>
</div>

<div id="entry" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
<select id="eStudent"></select>
<select id="eSubject"></select>
<select id="eType">
<option value="grade">–û—Ü–µ–Ω–∫–∞</option>
<option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
<option value="note">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
</select>
<input id="eValue" placeholder="–û—Ü–µ–Ω–∫–∞ (2-6)">
<input id="eReason" placeholder="–ü—Ä–∏—á–∏–Ω–∞">
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<table id="diaryTable"></table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase,ref,set,get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
 authDomain:"dnevnik2-42909.firebaseapp.com",
 databaseURL:"https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
 projectId:"dnevnik2-42909"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

let uid=null;
let data={students:{},subjects:{},program:[],diary:{}};

onAuthStateChanged(auth,u=>{
 if(u){uid=u.uid;load();menu.classList.remove("hidden");show("students")}
 else show("auth");
});

window.register=()=>createUserWithEmailAndPassword(auth,email.value,password.value);
window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.logout=()=>signOut(auth);

function save(){set(ref(db,"dnevnik/"+uid),data);}
function load(){get(ref(db,"dnevnik/"+uid)).then(s=>{if(s.exists())data=s.val();renderAll();});}

window.show=id=>{
 document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
};

window.addStudent=()=>{
 if(!studentName.value)return;
 data.students[studentName.value]={};
 save();renderAll();studentName.value="";
};

window.removeStudent=n=>{
 delete data.students[n];
 delete data.diary[n];
 save();renderAll();
};

window.addSubject=()=>{
 if(!subjectName.value||!subjectHours.value)return;
 data.subjects[subjectName.value]=+subjectHours.value;
 save();renderAll();subjectName.value=subjectHours.value="";
};

window.removeSubject=n=>{
 delete data.subjects[n];
 Object.values(data.diary).forEach(d=>delete d[n]);
 data.program=[];
 save();renderAll();
};

window.generateProgram=()=>{
 let sum=Object.values(data.subjects).reduce((a,b)=>a+b,0);
 if(sum!==18)return alert("–ß–∞—Å–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ 18");
 let pool=[];
 Object.entries(data.subjects).forEach(([s,h])=>{for(let i=0;i<h;i++)pool.push(s)});
 pool.sort(()=>Math.random()-0.5);
 data.program=[[],[],[]];
 for(let d=0;d<3;d++)for(let h=0;h<6;h++)data.program[d][h]=pool.pop();
 save();renderAll();
};

window.addEntry=()=>{
 let st=eStudent.value,sb=eSubject.value;
 if(!st||!sb)return;
 data.diary[st]??={};
 data.diary[st][sb]??={grades:[],praises:[],notes:[]};
 if(eType.value==="grade")data.diary[st][sb].grades.push({value:+eValue.value});
 if(eType.value==="praise")data.diary[st][sb].praises.push(eReason.value);
 if(eType.value==="note")data.diary[st][sb].notes.push(eReason.value);
 save();renderAll();eValue.value=eReason.value="";
};

function renderAll(){
 studentList.innerHTML=Object.keys(data.students)
  .map(s=>`<li>${s}<button class="danger" onclick="removeStudent('${s}')">‚úñ</button></li>`).join("");
 subjectList.innerHTML=Object.entries(data.subjects)
  .map(([s,h])=>`<li>${s} ‚Äì ${h}—á<button class="danger" onclick="removeSubject('${s}')">‚úñ</button></li>`).join("");
 eStudent.innerHTML=Object.keys(data.students).map(s=>`<option>${s}</option>`).join("");
 eSubject.innerHTML=Object.keys(data.subjects).map(s=>`<option>${s}</option>`).join("");
 renderProgram();renderDiary();
}

function renderProgram(){
 programTable.innerHTML="";
 if(!data.program.length)return;
 let h="<tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr>";
 for(let i=0;i<6;i++)h+=`<tr><td>${i+1}</td><td>${data.program[0][i]}</td><td>${data.program[1][i]}</td><td>${data.program[2][i]}</td></tr>`;
 programTable.innerHTML=h;
}

function renderDiary(){
 let subs=Object.keys(data.subjects),sts=Object.keys(data.students);
 if(!subs.length||!sts.length){diaryTable.innerHTML="";return;}
 let h="<tr><th>–£—á–µ–Ω–∏–∫</th>";
 subs.forEach(s=>h+=`<th colspan=3>${s}</th>`);
 h+="</tr><tr><th></th>";
 subs.forEach(()=>h+="<th>–û—Ü–µ–Ω–∫–∏</th><th>–ü–æ—Ö–≤–∞–ª–∏</th><th>–ó–∞–±–µ–ª–µ–∂–∫–∏</th>");
 h+="</tr>";
 sts.forEach(st=>{
  h+=`<tr><td>${st}</td>`;
  subs.forEach(sb=>{
   let d=data.diary[st]?.[sb]||{grades:[],praises:[],notes:[]};
   let avg=d.grades.length?(d.grades.reduce((a,g)=>a+g.value,0)/d.grades.length).toFixed(2):"‚Äì";
   h+=`<td>${d.grades.map(g=>`<span class="grade">${g.value}</span>`).join("")}<div class="avg">–°—Ä–µ–¥–µ–Ω: ${avg}</div></td>
       <td>${d.praises.join("<br>")}</td>
       <td>${d.notes.join("<br>")}</td>`;
  });
  h+="</tr>";
 });
 diaryTable.innerHTML=h;
}
</script>

</body>
</html>
