<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Arial;background:#f2f4f7;}
header{background:#2c3e50;color:white;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;flex-wrap:wrap;background:#34495e;}
nav button{flex:1;padding:12px;background:none;border:none;color:white;cursor:pointer;font-size:16px;}
nav button:hover{background:#2c3e50;}
.hidden{display:none;}
.container{padding:15px;}
.card{background:white;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input,select,textarea,button{width:100%;padding:8px;margin:6px 0;border-radius:5px;border:1px solid #ccc;}
button.action{background:#3498db;color:white;border:none;cursor:pointer;padding:10px;}
button.action:hover{background:#2980b9;}
.table-wrap{overflow-x:auto;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#3498db;color:white;}
.grade{display:inline-block;padding:4px 7px;border-radius:5px;color:white;font-weight:bold;margin:2px;cursor:pointer;}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="showSection('program')">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- LOGIN / REGISTER -->
<div id="authSection" class="card">
  <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</h3>
  <input id="authEmail" placeholder="–ò–º–µ–π–ª" type="email">
  <input id="authPass" placeholder="–ü–∞—Ä–æ–ª–∞" type="password">
  <button class="action" onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button class="action" onclick="loginUser()">–í—Ö–æ–¥</button>
</div>

<!-- –£–ß–ï–ù–ò–¶–ò -->
<div id="students" class="card hidden">
  <h3>–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</h3>
  <input id="newStudent" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
  <button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏</button>
  <div id="studentList"></div>
</div>

<!-- –í–™–í–ï–ñ–î–ê–ù–ï -->
<div id="input" class="card hidden">
  <h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
  <select id="entryType">
    <option value="grade">–û—Ü–µ–Ω–∫–∞</option>
    <option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
    <option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
  </select>
  <input id="entryStudent" placeholder="–£—á–µ–Ω–∏–∫">
  <select id="entrySubject"></select>

  <div id="gradeBox">
    <input id="gradeValue" type="number" placeholder="–û—Ü–µ–Ω–∫–∞ (2-6)">
    <input id="gradeAuthor" placeholder="–û—Ç –∫–æ–≥–æ">
    <input id="gradeReason" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ">
  </div>

  <textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>

  <button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- –î–ù–ï–í–ù–ò–ö -->
<div id="diary" class="card hidden">
  <h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
  <div class="table-wrap">
    <table>
      <thead id="diaryHead"></thead>
      <tbody id="diaryBody"></tbody>
    </table>
  </div>
</div>

<!-- –ü–†–û–ì–†–ê–ú–ê -->
<div id="program" class="card hidden">
  <h3>–°–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞</h3>
  <input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
  <input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
  <button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–µ–¥–º–µ—Ç</button>

  <table>
    <thead><tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr></thead>
    <tbody id="programTable"></tbody>
  </table>
</div>

</div>

<script>
// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "–í–ê–®–ò–Ø_API_KEY",
  authDomain: "–í–ê–®–ò–Ø_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://–í–ê–®–ò–Ø_PROJECT_ID.firebaseio.com",
  projectId: "–í–ê–®–ò–Ø_PROJECT_ID",
  storageBucket: "–í–ê–®–ò–Ø_PROJECT_ID.appspot.com",
  messagingSenderId: "–í–ê–®–ò–Ø_MESSAGING_ID",
  appId: "–í–ê–®–ò–Ø_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

let currentUid = null;
let students = {};
let subjects = [];
let program = [];

// ---------- SHOW SECTION ----------
function showSection(id){
  if(id !== 'authSection' && !currentUid) return alert("–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ!");
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  updateSubjectSelect();
  renderDiary();
  renderProgram();
  updateStudentList();
}

// ---------- AUTH ----------
function registerUser(){
  let email = authEmail.value.trim();
  let pass  = authPass.value.trim();
  if(!email || !pass) return alert("–ü–æ–ø—ä–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª–∞");

  auth.createUserWithEmailAndPassword(email, pass)
      .then(u => {
          currentUid = u.user.uid;
          students = {};
          subjects = [];
          program = [];
          db.ref("diary/" + currentUid).set({students, subjects, program})
            .then(() => {
                alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
                loginAfter(currentUid);
            });
      })
      .catch(err => alert(err.message));
}

function loginUser(){
  let email = authEmail.value.trim();
  let pass  = authPass.value.trim();
  if(!email || !pass) return alert("–ü–æ–ø—ä–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª–∞");

  auth.signInWithEmailAndPassword(email, pass)
      .then(u => loginAfter(u.user.uid))
      .catch(err => {
          if(err.code === "auth/user-not-found"){
              // –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—ä–∑–¥–∞–≤–∞–º–µ –∞–∫–∞—É–Ω—Ç, –∞–∫–æ –Ω—è–º–∞ —Ç–∞–∫—ä–≤
              registerUser();
          } else {
              alert(err.message);
          }
      });
}

function loginAfter(uid){
  currentUid = uid;
  authSection.classList.add('hidden');
  showSection('students');
  loadData();
}

function logout(){
  auth.signOut();
  location.reload();
}

// ---------- LOAD / SAVE ----------
function loadData(){
  db.ref("diary/"+currentUid).once("value", snap=>{
    let val = snap.val();
    if(val){
      students = val.students||{};
      subjects = val.subjects||[];
      program  = val.program||[];
    } else {
      students = {};
      subjects = [];
      program  = [];
      db.ref("diary/"+currentUid).set({students, subjects, program});
    }
    updateSubjectSelect();
    renderDiary();
    renderProgram();
    updateStudentList();
  });
}

function saveData(){
  if(!currentUid) return;
  db.ref("diary/"+currentUid).set({students, subjects, program});
}

// ---------- STUDENTS ----------
function addStudent(){
  let n = newStudent.value.trim();
  if(!n) return alert("–ù–µ–≤–∞–ª–∏–¥–Ω–æ –∏–º–µ");
  if(!students[n]) students[n]={};
  subjects.forEach(s=> students[n][s.name]={grades:[], remarks:[], praises:[]});
  newStudent.value="";
  saveData();
  renderDiary();
  updateStudentList();
}

function updateStudentList(){
  studentList.innerHTML="";
  for(let st in students){
    let div = document.createElement("div");
    div.textContent=st;
    let btn = document.createElement("button");
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick=()=>{delete students[st]; saveData(); renderDiary(); updateStudentList();}
    div.appendChild(btn);
    studentList.appendChild(div);
  }
}

// ---------- SUBJECTS ----------
function addSubject(){
  let n = subjectName.value.trim();
  let h = +subjectHours.value;
  if(!n || !h) return alert("–ü–æ–ø—ä–ª–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç –∏ —á–∞—Å–æ–≤–µ");
  
  // –∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–∞–º–µ —á–∞—Å–æ–≤–µ—Ç–µ
  let exists = subjects.find(s=>s.name===n);
  if(exists) { exists.hours = h; }
  else { subjects.push({name:n,hours:h}); }

  for(let st in students){
    if(!students[st][n]) students[st][n]={grades:[], remarks:[], praises:[]};
  }
  subjectName.value=subjectHours.value="";
  saveData();
  updateSubjectSelect();
  renderDiary();
}

// ---------- SUBJECT SELECT ----------
function updateSubjectSelect(){
  entrySubject.innerHTML=subjects.map(s=>`<option>${s.name}</option>`).join("");
}

// ---------- PROGRAM ----------
function generateProgram(){
  let pool=[];
  subjects.forEach(s=>{for(let i=0;i<s.hours;i++) pool.push(s.name);});
  pool.sort(()=>Math.random()-0.5);
  program=[];
  for(let h=0;h<6;h++){ program[h]=[pool.pop()||"", pool.pop()||"", pool.pop()||""]; }
  saveData();
  renderProgram();
}

function renderProgram(){
  let t="";
  for(let i=0;i<6;i++){
    t+=`<tr><td>${i+1}</td>`;
    for(let d=0;d<3;d++) t+=`<td>${program[i]?.[d]||""}</td>`;
    t+="</tr>";
  }
  programTable.innerHTML=t;
}

// ---------- INPUT ----------
entryType.onchange=()=>{gradeBox.classList.toggle("hidden", entryType.value!=="grade"); textValue.classList.toggle("hidden", entryType.value==="grade");};

function addEntry(){
  let st = entryStudent.value.trim();
  let sub = entrySubject.value;
  if(!students[st]) return alert("–ù—è–º–∞ —Ç–∞–∫—ä–≤ —É—á–µ–Ω–∏–∫");
  let box = students[st][sub];

  if(entryType.value==="grade"){ box.grades.push({value:+gradeValue.value, author:gradeAuthor.value, reason:gradeReason.value}); }
  else if(entryType.value==="remark"){ box.remarks.push(textValue.value); }
  else { box.praises.push(textValue.value); }

  gradeValue.value=gradeAuthor.value=gradeReason.value=textValue.value="";
  saveData();
  renderDiary();
}

// ---------- DIARY ----------
function gradeColor(v){return {2:"#c0392b",3:"#e67e22",4:"#f1c40f",5:"#3498db",6:"#2ecc71"}[v]||"#777";}

function renderDiary(){
  if(!subjects.length){diaryHead.innerHTML=""; diaryBody.innerHTML=""; return;}
  let h="<tr><th>–£—á–µ–Ω–∏–∫</th>";
  subjects.forEach(s=>h+=`<th>${s.name}</th>`);
  h+="</tr>"; diaryHead.innerHTML=h;

  let b="";
  for(let st in students){
    b+=`<tr><td>${st}</td>`;
    subjects.forEach(s=>{
      let d = students[st][s.name];
      let gradesHTML = d.grades.map(g=>`<span class="grade" style="background:${gradeColor(g.value)}">${g.value}</span>`).join("");
      let remarksHTML = d.remarks.join("<br>")||"-";
      let praisesHTML = d.praises.join("<br>")||"-";
      b+=`<td>–û—Ü: ${gradesHTML}<br>–ó: ${remarksHTML}<br>–ü: ${praisesHTML}</td>`;
    });
    b+="</tr>";
  }
  diaryBody.innerHTML=b;
}

// ---------- INIT ----------
showSection('authSection');
</script>
</body>
</html>


