<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Електронен училищен дневник</title>
<style>
body{margin:0;font-family:Arial;background:#f2f4f7;}
header{background:#2c3e50;color:white;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;flex-wrap:wrap;background:#34495e;}
nav button{flex:1;padding:12px;background:none;border:none;color:white;cursor:pointer;font-size:16px;}
nav button:hover{background:#2c3e50;}
.hidden{display:none;}
.container{padding:15px;}
.card{background:white;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input,select,textarea,button{width:100%;padding:8px;margin:6px 0;border-radius:5px;border:1px solid #ccc;}
button.action{background:#3498db;color:white;border:none;cursor:pointer;padding:10px;}
button.action:hover{background:#2980b9;}
.table-wrap{overflow-x:auto;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#3498db;color:white;}
.grade{display:inline-block;padding:4px 7px;border-radius:5px;color:white;font-weight:bold;margin:2px;cursor:pointer;}
</style>
<!-- Firebase Modular SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909",
  storageBucket: "dnevnik2-42909.appspot.com",
  messagingSenderId: "824393263608",
  appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
};

// Инициализация
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUid = null;
let students = {};
let subjects = [];
let program = [];

// ---------- SHOW SECTION ----------
function showSection(id){
  if(id !== 'authSection' && !currentUid) return alert("Моля, влезте!");
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  updateSubjectSelect();
  renderDiary();
  renderProgram();
  updateStudentList();
}

// ---------- AUTH ----------
window.registerUser = function(){
  const email = document.getElementById('authEmail').value.trim();
  const pass = document.getElementById('authPass').value.trim();
  if(!email || !pass) return alert("Попълни email и парола");

  createUserWithEmailAndPassword(auth, email, pass)
    .then(userCredential => {
      currentUid = userCredential.user.uid;
      students = {}; subjects = []; program = [];
      set(ref(db, 'diary/' + currentUid), {students, subjects, program})
        .then(()=> { alert("Регистрация успешна!"); loginAfter(currentUid); });
    })
    .catch(err=> alert(err.message));
};

window.loginUser = function(){
  const email = document.getElementById('authEmail').value.trim();
  const pass = document.getElementById('authPass').value.trim();
  if(!email || !pass) return alert("Попълни email и парола");

  signInWithEmailAndPassword(auth, email, pass)
    .then(userCredential => loginAfter(userCredential.user.uid))
    .catch(err => {
      if(err.code === "auth/user-not-found"){ registerUser(); }
      else alert(err.message);
    });
};

function loginAfter(uid){
  currentUid = uid;
  document.getElementById('authSection').classList.add('hidden');
  showSection('students');
  loadData();
}

window.logout = function(){
  signOut(auth).then(()=> location.reload());
};

// ---------- LOAD / SAVE ----------
function loadData(){
  get(child(ref(db), 'diary/' + currentUid)).then(snap=>{
    if(snap.exists()){
      const val = snap.val();
      students = val.students||{};
      subjects = val.subjects||[];
      program = val.program||[];
    } else {
      students = {}; subjects = []; program = [];
      set(ref(db, 'diary/' + currentUid), {students, subjects, program});
    }
    updateSubjectSelect();
    renderDiary();
    renderProgram();
    updateStudentList();
  });
}

function saveData(){
  if(!currentUid) return;
  set(ref(db, 'diary/' + currentUid), {students, subjects, program});
}

// ---------- STUDENTS ----------
window.addStudent = function(){
  const n = document.getElementById('newStudent').value.trim();
  if(!n) return alert("Невалидно име");
  if(!students[n]) students[n]={};
  subjects.forEach(s=> students[n][s.name]={grades:[], remarks:[], praises:[]});
  document.getElementById('newStudent').value="";
  saveData(); renderDiary(); updateStudentList();
}

function updateStudentList(){
  const studentList = document.getElementById('studentList');
  studentList.innerHTML="";
  for(let st in students){
    const div = document.createElement("div");
    div.textContent=st;
    const btn = document.createElement("button");
    btn.textContent="Премахни";
    btn.onclick = ()=>{ delete students[st]; saveData(); renderDiary(); updateStudentList(); };
    div.appendChild(btn);
    studentList.appendChild(div);
  }
}

// ---------- SUBJECTS ----------
window.addSubject = function(){
  const n = document.getElementById('subjectName').value.trim();
  const h = +document.getElementById('subjectHours').value;
  if(!n || !h) return alert("Попълни предмет и часове");

  const exists = subjects.find(s=>s.name===n);
  if(exists) exists.hours = h; else subjects.push({name:n, hours:h});

  for(let st in students){
    if(!students[st][n]) students[st][n]={grades:[], remarks:[], praises:[]};
  }
  document.getElementById('subjectName').value="";
  document.getElementById('subjectHours').value="";
  saveData(); updateSubjectSelect(); renderDiary();
}

function updateSubjectSelect(){
  const entrySubject = document.getElementById('entrySubject');
  entrySubject.innerHTML = subjects.map(s=>`<option>${s.name}</option>`).join("");
}

// ---------- PROGRAM ----------
window.generateProgram = function(){
  let pool=[];
  subjects.forEach(s=>{ for(let i=0;i<s.hours;i++) pool.push(s.name); });
  pool.sort(()=>Math.random()-0.5);
  program=[];
  for(let h=0;h<6;h++){ program[h]=[pool.pop()||"", pool.pop()||"", pool.pop()||""]; }
  saveData(); renderProgram();
}

function renderProgram(){
  let t="";
  for(let i=0;i<6;i++){
    t+=`<tr><td>${i+1}</td>`;
    for(let d=0;d<3;d++) t+=`<td>${program[i]?.[d]||""}</td>`;
    t+="</tr>";
  }
  document.getElementById('programTable').innerHTML=t;
}

// ---------- INPUT ----------
document.getElementById('entryType').onchange = function(){
  const gradeBox = document.getElementById('gradeBox');
  const textValue = document.getElementById('textValue');
  gradeBox.classList.toggle("hidden", this.value!=="grade");
  textValue.classList.toggle("hidden", this.value==="grade");
};

window.addEntry = function(){
  const st = document.getElementById('entryStudent').value.trim();
  const sub = document.getElementById('entrySubject').value;
  if(!students[st]) return alert("Няма такъв ученик");
  const box = students[st][sub];

  if(document.getElementById('entryType').value==="grade"){
    box.grades.push({
      value:+document.getElementById('gradeValue').value,
      author:document.getElementById('gradeAuthor').value,
      reason:document.getElementById('gradeReason').value
    });
  } else if(document.getElementById('entryType').value==="remark"){
    box.remarks.push(document.getElementById('textValue').value);
  } else {
    box.praises.push(document.getElementById('textValue').value);
  }

  document.getElementById('gradeValue').value="";
  document.getElementById('gradeAuthor').value="";
  document.getElementById('gradeReason').value="";
  document.getElementById('textValue').value="";
  saveData(); renderDiary();
}

// ---------- DIARY ----------
function gradeColor(v){ return {2:"#c0392b",3:"#e67e22",4:"#f1c40f",5:"#3498db",6:"#2ecc71"}[v]||"#777"; }

function renderDiary(){
  if(!subjects.length){ document.getElementById('diaryHead').innerHTML=""; document.getElementById('diaryBody').innerHTML=""; return; }
  let h="<tr><th>Ученик</th>";
  subjects.forEach(s=> h+=`<th>${s.name}</th>`); h+="</tr>";
  document.getElementById('diaryHead').innerHTML = h;

  let b="";
  for(let st in students){
    b+=`<tr><td>${st}</td>`;
    subjects.forEach(s=>{
      const d = students[st][s.name];
      const gradesHTML = d.grades.map(g=>`<span class="grade" style="background:${gradeColor(g.value)}">${g.value}</span>`).join("");
      const remarksHTML = d.remarks.join("<br>")||"-";
      const praisesHTML = d.praises.join("<br>")||"-";
      b+=`<td>Оц: ${gradesHTML}<br>З: ${remarksHTML}<br>П: ${praisesHTML}</td>`;
    });
    b+="</tr>";
  }
  document.getElementById('diaryBody').innerHTML=b;
}

// ---------- INIT ----------
showSection('authSection');
</script>
</head>
<body>
</body>
</html>



