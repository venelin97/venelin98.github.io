<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    margin:0;
    font-family:Segoe UI,Arial;
    background:linear-gradient(135deg,#667eea,#764ba2);
}
.container{max-width:1400px;margin:auto;padding:20px}
header{
    background:white;
    padding:20px;
    border-radius:14px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 10px 30px rgba(0,0,0,.15)
}
header h1{color:#667eea;margin:0}

.menu{margin:20px 0;display:none;gap:10px;flex-wrap:wrap}
.menu button{
    background:#667eea;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:8px;
    cursor:pointer
}
.menu button.active{background:#764ba2}

.card{
    background:white;
    padding:25px;
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    display:none
}
.card.active{display:block}

input,select,button{
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    margin:6px 0;
    width:100%
}
button{cursor:pointer}

.grade-box{
    width:36px;
    height:36px;
    border-radius:8px;
    color:white;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    margin:3px;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,.25)
}

/* POPUP */
.popup-bg{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.45);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999
}
.popup{
    background:white;
    border-radius:18px;
    padding:25px;
    min-width:320px;
    position:relative;
    box-shadow:0 30px 60px rgba(0,0,0,.4);
    color:black
}
.popup .close{
    position:absolute;
    top:12px;
    right:16px;
    font-size:22px;
    color:red;
    cursor:pointer
}
.popup button{
    background:#e74c3c;
    color:white;
    border:none;
    padding:10px 16px;
    margin-top:15px;
    border-radius:8px
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px
}
th,td{
    border:1px solid #ddd;
    padding:8px;
    text-align:center
}
th{background:#667eea;color:white}

.avg{margin-top:5px;font-weight:bold;color:#667eea}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, push, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909",
  storageBucket: "dnevnik2-42909.appspot.com",
  messagingSenderId: "824393263608",
  appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let user=null, students={}, subjects={}, entries={};

/* üîë AUTH */
window.register=()=>createUserWithEmailAndPassword(auth,email.value,password.value)
window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value)
window.logout=()=>signOut(auth)

onAuthStateChanged(auth,u=>{
    if(u){
        user=u;
        menu.style.display='flex';
        authCard.classList.remove('active');
        studentsCard.classList.add('active');
        loadAll();
    }else{
        user=null;
        menu.style.display='none';
        authCard.classList.add('active');
    }
});

/* üì• DATA */
function loadAll(){
    onValue(ref(db,`users/${user.uid}/students`),s=>{students=s.val()||{};renderStudents();renderJournal()});
    onValue(ref(db,`users/${user.uid}/subjects`),s=>{subjects=s.val()||{};renderJournal()});
    onValue(ref(db,`users/${user.uid}/entries`),s=>{entries=s.val()||{};renderJournal()});
}

/* üé® GRADE COLOR */
function gradeColor(v){
    if(v>=6) return 'linear-gradient(135deg,#2ecc71,#27ae60)';
    if(v>=5) return 'linear-gradient(135deg,#3498db,#2980b9)';
    if(v>=4) return 'linear-gradient(135deg,#f1c40f,#f39c12)';
    if(v>=3) return 'linear-gradient(135deg,#e67e22,#d35400)';
    return 'linear-gradient(135deg,#8e0e00,#c0392b)';
}

/* üìò JOURNAL */
function renderJournal(){
    journal.innerHTML='';
    let html='<table><tr><th>–£—á–µ–Ω–∏–∫</th>';
    Object.values(subjects).forEach(s=>html+=`<th>${s.name}</th>`);
    html+='</tr>';

    Object.entries(students).forEach(([sid,s])=>{
        html+=`<tr><td>${s.name}</td>`;
        Object.keys(subjects).forEach(sub=>{
            html+='<td>';
            Object.entries(entries[sid]?.[sub]||{}).forEach(([eid,e])=>{
                const text=e.type==='grade'?e.value:(e.type==='praise'?'–ü':'–ó');
                const bg=e.type==='grade'?gradeColor(e.value):(e.type==='praise'?'#3498db':'#e67e22');
                html+=`<div class="grade-box" style="background:${bg}"
                onclick="openPopup('${sid}','${sub}','${eid}')">${text}</div>`;
            });
            html+='</td>';
        });
        html+='</tr>';
    });

    journal.innerHTML=html+'</table>';
}

/* üìå POPUP */
window.openPopup=(sid,sub,eid)=>{
    const e=entries[sid][sub][eid];
    const bg=document.createElement('div');
    bg.className='popup-bg';
    bg.innerHTML=`
    <div class="popup">
        <span class="close">‚úñ</span>
        <h3>${e.type==='grade'?'–û—Ü–µ–Ω–∫–∞':'–û—Ç–∑–∏–≤'}</h3>
        ${e.value?`<p><b>–°—Ç–æ–π–Ω–æ—Å—Ç:</b> ${e.value}</p>`:''}
        <p><b>–ü—Ä–∏—á–∏–Ω–∞:</b> ${e.reason}</p>
        <p><b>–û—Ç:</b> ${e.teacher}</p>
        <button>–ò–∑—Ç—Ä–∏–π</button>
    </div>`;
    bg.querySelector('.close').onclick=()=>bg.remove();
    bg.querySelector('button').onclick=()=>{
        remove(ref(db,`users/${user.uid}/entries/${sid}/${sub}/${eid}`));
        bg.remove();
    };
    document.body.appendChild(bg);
}
</script>
</head>

<body>
<div class="container">

<header>
<h1>üìö –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</h1>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</header>

<div class="menu" id="menu">
<button onclick="show('studentsCard')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="show('journalCard')">–î–Ω–µ–≤–Ω–∏–∫</button>
</div>

<div class="card active" id="authCard">
<input id="email" placeholder="email">
<input id="password" type="password" placeholder="password">
<button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button onclick="login()">–í—Ö–æ–¥</button>
</div>

<div class="card" id="studentsCard"></div>
<div class="card" id="journalCard"><div id="journal"></div></div>

</div>

<script>
function show(id){
    document.querySelectorAll('.card').forEach(c=>c.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}
</script>
</body>
</html>
