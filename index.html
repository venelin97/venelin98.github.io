<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}
input,select{width:100%;padding:8px;margin:5px 0}
button.action{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
button.action:hover{opacity:.9}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #cbd5e1;padding:6px;text-align:center}
th{background:#e5e7eb}
.grade{display:inline-block;padding:4px 6px;margin:2px;border-radius:4px;color:#fff;cursor:pointer}
.avg{background:#64748b!important}
</style>
</head>

<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="show('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="show('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ & –ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="show('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏</button>
<ul id="studentList"></ul>
</div>

<!-- SUBJECTS -->
<div id="subjects" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏ (–æ–±—â–æ 18 —á–∞—Å–∞)</h3>
<input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" min="1" placeholder="–ß–∞—Å–∞ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ –ø—Ä–µ–¥–º–µ—Ç</button>
<ul id="subjectList"></ul>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<div id="programTable"></div>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<select id="termSelect" onchange="renderDiary()">
<option value="term1">–ü—ä—Ä–≤–∏ —Å—Ä–æ–∫</option>
<option value="term2">–í—Ç–æ—Ä–∏ —Å—Ä–æ–∫</option>
</select>
<div id="diaryTable"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid=null;
let data={
 students:{},
 subjects:{},
 program:{},
 diary:{ term1:{}, term2:{} }
};

window.show=id=>{
 if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑");
 document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
 if(id==="diary") renderDiary();
};

window.register=()=>{
 createUserWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid;save();show("students")})
 .catch(e=>alert(e.message));
};

window.login=()=>{
 signInWithEmailAndPassword(auth,email.value,password.value)
 .then(u=>{uid=u.user.uid;load();show("students")})
 .catch(e=>alert(e.message));
};

window.logout=()=>signOut(auth).then(()=>location.reload());

function save(){
 set(ref(db,"dnevnik/"+uid),data);
}

function load(){
 get(ref(db,"dnevnik/"+uid)).then(s=>{
  if(s.exists()) data=s.val();
  renderAll();
 });
}

window.addStudent=()=>{
 if(!studentName.value) return;
 data.students[studentName.value]=true;
 studentName.value="";
 save();renderAll();
};

window.addSubject=()=>{
 const n=subjectName.value;
 const h=Number(subjectHours.value);
 if(!n||!h) return;
 data.subjects[n]=h;
 subjectName.value="";subjectHours.value="";
 save();renderAll();
};

window.generateProgram=()=>{
 const total=Object.values(data.subjects).reduce((a,b)=>a+b,0);
 if(total!==18) return alert("–ß–∞—Å–æ–≤–µ—Ç–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ —Ç–æ—á–Ω–æ 18");
 let arr=[];
 Object.entries(data.subjects).forEach(([s,h])=>{
  for(let i=0;i<h;i++) arr.push(s);
 });
 arr.sort(()=>Math.random()-0.5);
 data.program={};
 let i=0;
 ["–ü–æ–Ω","–í—Ç","–°—Ä"].forEach(d=>{
  data.program[d]=[];
  for(let h=0;h<6;h++) data.program[d].push(arr[i++]);
 });
 save();renderAll();
};

function renderAll(){
 studentList.innerHTML=Object.keys(data.students)
 .map(s=>`<li>${s}</li>`).join("");

 subjectList.innerHTML=Object.entries(data.subjects)
 .map(([s,h])=>`<li>${s} ‚Äì ${h}—á</li>`).join("");

 let p="<table><tr><th>–î–µ–Ω</th>"+[1,2,3,4,5,6].map(h=>`<th>${h}</th>`).join("")+"</tr>";
 Object.entries(data.program).forEach(([d,h])=>{
  p+="<tr><td>"+d+"</td>"+h.map(x=>`<td>${x}</td>`).join("")+"</tr>";
 });
 p+="</table>";
 programTable.innerHTML=p;
}

window.renderDiary=()=>{
 const term=termSelect.value;
 let html="<table><tr><th>–£—á–µ–Ω–∏–∫</th>";
 Object.keys(data.subjects).forEach(s=>{
  html+=`<th colspan="3">${s}</th>`;
 });
 html+="</tr><tr><th></th>";
 Object.keys(data.subjects).forEach(_=>{
  html+="<th>–û—Ü–µ–Ω–∫–∏</th><th>–ü–æ—Ö–≤–∞–ª–∏</th><th>–ó–∞–±–µ–ª–µ–∂–∫–∏</th>";
 });
 html+="</tr>";

 Object.keys(data.students).forEach(st=>{
  html+="<tr><td>"+st+"</td>";
  Object.keys(data.subjects).forEach(sub=>{
   let cell=data.diary[term]?.[st]?.[sub]||{};
   let grades=cell.grades||{};
   let vals=Object.values(grades).map(g=>g.value);
   let avg=vals.length?(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(2):"‚Äì";
   html+=`<td>${Object.entries(grades).map(([id,g])=>
    `<span class="grade" style="background:#2563eb" title="–û—Ç: ${g.author} | ${g.reason}"
     onclick="deleteGrade('${term}','${st}','${sub}','${id}')">${g.value}</span>`
   ).join("")}<span class="grade avg">${avg}</span></td>`;
   html+=`<td></td><td></td>`;
  });
  html+="</tr>";
 });
 html+="</table>";
 diaryTable.innerHTML=html;
};

window.deleteGrade=(term,st,sub,id)=>{
 if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")){
  delete data.diary[term][st][sub].grades[id];
  save();renderDiary();
 }
};

show("auth");
</script>

</body>
</html>
