<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI,sans-serif;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1200px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}
input,select,textarea{width:100%;padding:8px;margin:6px 0;border-radius:5px;border:1px solid #cbd5e1}
button.action{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:5px;cursor:pointer;margin-top:5px}
button.action:hover{opacity:.9}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #e5e7eb;padding:6px;text-align:center;vertical-align:top}
th{background:#e5e7eb}
.grade, .average{display:block;padding:2px 5px;margin:2px;border-radius:4px;color:#fff;font-weight:bold;cursor:pointer}
.grade:hover{opacity:.8}
.average{background:#16a34a;color:#fff;margin-top:5px;font-size:0.85em}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>
<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('subjects')">–ü—Ä–µ–¥–º–µ—Ç–∏ –∏ –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- SUBJECTS AND PROGRAM -->
<div id="subjects" class="card hidden">
<h3>–ü—Ä–µ–¥–º–µ—Ç–∏ –∏ —Å–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞</h3>
<input id="subjectName" placeholder="–ò–º–µ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç">
<input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
<button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏/–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–µ–¥–º–µ—Ç</button>

<ul id="subjectList"></ul>

<h4>–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ (3 –¥–Ω–∏ √ó 6 —á–∞—Å–∞)</h4>
<button class="action" onclick="generateProgram()">–ì–µ–Ω–µ—Ä–∏—Ä–∞–π –ø—Ä–æ–≥—Ä–∞–º–∞</button>
<table id="programTable"></table>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<select id="termSelect">
<option value="1">–ü—ä—Ä–≤–∏ —Å—Ä–æ–∫</option>
<option value="2">–í—Ç–æ—Ä–∏ —Å—Ä–æ–∫</option>
</select>
<table id="diaryTable"></table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
  authDomain: "dnevnik2-42909.firebaseapp.com",
  databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dnevnik2-42909",
  storageBucket: "dnevnik2-42909.appspot.com",
  messagingSenderId: "824393263608",
  appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let uid = null;
let students = {};
let subjects = {};
let program = [];
let diary = {1:{},2:{}}; // term 1 and 2

/* UI */
window.showSection = id=>{
  if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑!");
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  render();
}

/* AUTH */
window.register = ()=>{
  createUserWithEmailAndPassword(auth,email.value,password.value)
    .then(u=>{uid=u.user.uid;save();showSection('students');})
    .catch(e=>alert(e.message));
};

window.login = ()=>{
  signInWithEmailAndPassword(auth,email.value,password.value)
    .then(u=>{uid=u.user.uid;load();showSection('students');})
    .catch(e=>alert(e.message));
};

window.logout = ()=>signOut(auth).then(()=>location.reload());

/* SAVE / LOAD */
function save(){
  set(ref(db,"diary/"+uid),{students,subjects,program,diary});
}

function load(){
  get(ref(db,child(ref(db),"diary/"+uid))).then(s=>{
    if(s.exists()){
      ({students,subjects,program,diary}=s.val());
    }
    render();
  });
}

/* STUDENTS */
window.addStudent = ()=>{
  const name = studentName.value.trim();
  if(!name) return;
  if(!students[name]) students[name]={};
  studentName.value="";
  save(); render();
}

function renderStudents(){
  studentList.innerHTML="";
  Object.keys(students).forEach(s=>{
    const li=document.createElement("li");
    li.textContent=s;
    const btn=document.createElement("button");
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick=()=>{delete students[s]; save(); render();}
    li.appendChild(btn);
    studentList.appendChild(li);
  });
}

/* SUBJECTS & PROGRAM */
window.addSubject = ()=>{
  const name = subjectName.value.trim();
  const hours = +subjectHours.value;
  if(!name || !hours) return alert("–ü–æ–ø—ä–ª–Ω–∏ –∏–º–µ –∏ —á–∞—Å–æ–≤–µ");
  subjects[name]={hours};
  subjectName.value=""; subjectHours.value="";
  save(); render();
}

function renderSubjects(){
  subjectList.innerHTML="";
  Object.entries(subjects).forEach(([sub,hours])=>{
    const li=document.createElement("li");
    li.textContent=`${sub} - ${hours} —á.`;
    const btn=document.createElement("button");
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick=()=>{delete subjects[sub]; save(); render();}
    li.appendChild(btn);
    subjectList.appendChild(li);
  });
  renderProgramTable();
}

window.generateProgram = ()=>{
  let totalHours = Object.values(subjects).reduce((a,v)=>a+v.hours,0);
  if(totalHours!==18) return alert("–û–±—â–∏—Ç–µ —á–∞—Å–æ–≤–µ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å–∞ 18!");
  // generate 3 days x 6 hours
  program=[];
  const subArr=Object.keys(subjects);
  for(let d=0;d<3;d++){
    program[d]=[];
    let remaining=6;
    while(remaining>0){
      const sub=subArr[Math.floor(Math.random()*subArr.length)];
      if(program[d].filter(s=>s===sub).length<subjects[sub].hours){
        program[d].push(sub);
        remaining--;
      }
    }
  }
  save(); renderProgramTable();
}

function renderProgramTable(){
  programTable.innerHTML="";
  if(program.length===0) return;
  let html="<tr><th>–ß–∞—Å/–î–µ–Ω</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr>";
  for(let h=0;h<6;h++){
    html+="<tr><td>"+(h+1)+"</td>";
    for(let d=0;d<3;d++){
      html+="<td>"+(program[d][h]||"")+"</td>";
    }
    html+="</tr>";
  }
  programTable.innerHTML=html;
}

/* DIARY */
function renderDiary(){
  diaryTable.innerHTML="";
  const term=termSelect.value;
  if(!Object.keys(students).length || !Object.keys(subjects).length) return;
  // header
  let html="<tr><th>–£—á–µ–Ω–∏–∫</th>";
  Object.keys(subjects).forEach(s=>{
    html+=`<th>${s}<br>–û—Ü–µ–Ω–∫–∏<br>–ü–æ—Ö–≤–∞–ª–∏<br>–ó–∞–±–µ–ª–µ–∂–∫–∏<br>–°—Ä–µ–¥–µ–Ω —É—Å–ø–µ—Ö</th>`;
  });
  html+="</tr>";
  // rows
  Object.keys(students).forEach(st=>{
    html+="<tr><td>"+st+"</td>";
    Object.keys(subjects).forEach(sub=>{
      let gradesArr = diary[term][st]?.[sub]?.grades||[];
      let praisesArr = diary[term][st]?.[sub]?.praises||[];
      let remarksArr = diary[term][st]?.[sub]?.remarks||[];
      let avg = gradesArr.length ? (gradesArr.reduce((a,v)=>a+v.value,0)/gradesArr.length).toFixed(2) : "";
      let cell=`<div>${gradesArr.map(g=>`<span class="grade" title="–û—Ç: ${g.author}, –ü—Ä–∏—á–∏–Ω–∞: ${g.reason}" onclick="deleteGrade('${term}','${st}','${sub}',${gradesArr.indexOf(g)})">${g.value}</span>`).join(" ")}</div>`;
      cell+=`<div>${praisesArr.join(", ")}</div>`;
      cell+=`<div>${remarksArr.join(", ")}</div>`;
      cell+=`<div class="average">${avg}</div>`;
      html+="<td>"+cell+"</td>";
    });
    html+="</tr>";
  });
  diaryTable.innerHTML=html;
}

function deleteGrade(term,st,sub,index){
  if(confirm("–ò—Å–∫–∞—Ç–µ –ª–∏ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –æ—Ü–µ–Ω–∫–∞—Ç–∞?")){
    diary[term][st][sub].grades.splice(index,1);
    save(); renderDiary();
  }
}

/* Render all */
function render(){
  renderStudents();
  renderSubjects();
  renderDiary();
  renderProgramTable();
}

showSection('auth');
</script>
</body>
</html>
