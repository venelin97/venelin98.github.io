<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Segoe UI;background:#f1f5f9}
header{background:#1e293b;color:#fff;padding:15px;text-align:center;font-size:22px}
nav{display:flex;background:#334155}
nav button{flex:1;padding:12px;border:none;background:none;color:#fff;cursor:pointer}
nav button:hover{background:#475569}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
.hidden{display:none}
input,select,textarea{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #cbd5e1}
button.action{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer}
button.action:hover{opacity:.9}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:center}
th{background:#e5e7eb}
.grade{padding:4px 7px;border-radius:5px;color:#fff;font-weight:bold}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
<h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
<input id="email" type="email" placeholder="–ò–º–µ–π–ª">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª–∞">
<button class="action" onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
<button class="action" onclick="login()">–í—Ö–æ–¥</button>
</div>

<!-- STUDENTS -->
<div id="students" class="card hidden">
<h3>–£—á–µ–Ω–∏—Ü–∏</h3>
<input id="studentName" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
<button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</button>
<ul id="studentList"></ul>
</div>

<!-- INPUT -->
<div id="input" class="card hidden">
<h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
<select id="studentSelect"></select>
<select id="subjectSelect"></select>
<select id="entryType">
<option value="grade">–û—Ü–µ–Ω–∫–∞</option>
<option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
<option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
</select>

<input id="grade" type="number" min="2" max="6" placeholder="–û—Ü–µ–Ω–∫–∞">
<textarea id="text" placeholder="–¢–µ–∫—Å—Ç" class="hidden"></textarea>
<button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- DIARY -->
<div id="diary" class="card hidden">
<h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
<table>
<thead id="thead"></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
 apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
 authDomain: "dnevnik2-42909.firebaseapp.com",
 databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
 projectId: "dnevnik2-42909"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// State
let uid = null;
let students = {};
let subjects = ["–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞","–ë–ï–õ"];
let entries = {}; // structure: entries[student][subject] = {grades:[],remarks:[],praises:[]}

// UI helper
const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");
const studentNameEl = document.getElementById("studentName");
const studentSelect = document.getElementById("studentSelect");
const subjectSelect = document.getElementById("subjectSelect");
const gradeEl = document.getElementById("grade");
const textEl = document.getElementById("text");
const entryTypeEl = document.getElementById("entryType");

window.showSection = id => {
 if(!uid && id!=="auth") return alert("–ü—ä—Ä–≤–æ –≤–ª–µ–∑!");
 document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));
 document.getElementById(id).classList.remove("hidden");
 render();
};

// AUTH
window.register = () => {
 if(!emailEl.value || !passwordEl.value) return alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞");
 createUserWithEmailAndPassword(auth,emailEl.value,passwordEl.value)
 .then(u=>{
   uid=u.user.uid;
   students={}; entries={};
   set(ref(db,"diary/"+uid),{students,subjects,entries}).then(()=>showSection('students'));
 })
 .catch(e=>alert(e.message));
};

window.login = () => {
 if(!emailEl.value || !passwordEl.value) return alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –∏–º–µ–π–ª –∏ –ø–∞—Ä–æ–ª–∞");
 signInWithEmailAndPassword(auth,emailEl.value,passwordEl.value)
 .then(u=>{
   uid=u.user.uid;
   load();
   showSection('students');
 })
 .catch(e=>alert(e.message));
};

window.logout = () => signOut(auth).then(()=>location.reload());

// DATABASE
function save() {
 set(ref(db,"diary/"+uid),{students,subjects,entries});
}

function load() {
 get(ref(db,"diary/"+uid)).then(s=>{
   if(s.exists()){
     students = s.val().students||{};
     subjects = s.val().subjects||subjects;
     entries = s.val().entries||{};
   }
   render();
});
}

// ACTIONS
window.addStudent = () => {
 const name = studentNameEl.value.trim();
 if(!name) return;
 students[name]={};
 subjects.forEach(sub=>{
   if(!entries[name]) entries[name]={};
   entries[name][sub]={grades:[],remarks:[],praises:[]};
 });
 studentNameEl.value="";
 save();
 render();
};

entryTypeEl.addEventListener("change",()=>{
 if(entryTypeEl.value==="grade"){ gradeEl.classList.remove("hidden"); textEl.classList.add("hidden"); }
 else { gradeEl.classList.add("hidden"); textEl.classList.remove("hidden"); }
});

window.addEntry = () => {
 const st = studentSelect.value;
 const sb = subjectSelect.value;
 if(!st || !sb) return;
 if(entryTypeEl.value==="grade"){
   const g = parseInt(gradeEl.value);
   if(!g) return alert("–ü–æ–ø—ä–ª–Ω–µ—Ç–µ –æ—Ü–µ–Ω–∫–∞");
   entries[st][sb].grades.push(g);
   gradeEl.value="";
 } else if(entryTypeEl.value==="remark"){
   if(!textEl.value) return;
   entries[st][sb].remarks.push(textEl.value);
   textEl.value="";
 } else {
   if(!textEl.value) return;
   entries[st][sb].praises.push(textEl.value);
   textEl.value="";
 }
 save();
 render();
};

// RENDER
function render() {
 // student list
 document.getElementById("studentList").innerHTML = Object.keys(students).map(s=>`<li>${s}</li>`).join("");
 // dropdowns
 studentSelect.innerHTML = Object.keys(students).map(s=>`<option>${s}</option>`).join("");
 subjectSelect.innerHTML = subjects.map(s=>`<option>${s}</option>`).join("");
 // diary
 const thead = document.getElementById("thead");
 const tbody = document.getElementById("tbody");
 thead.innerHTML="<tr><th>–£—á–µ–Ω–∏–∫</th>"+subjects.map(s=>`<th>${s}</th>`).join("")+"</tr>";
 tbody.innerHTML=Object.keys(students).map(st=>{
   return "<tr><td>"+st+"</td>"+subjects.map(sb=>{
     const gs = entries[st][sb].grades||[];
     const rs = entries[st][sb].remarks||[];
     const ps = entries[st][sb].praises||[];
     const gHtml = gs.map(g=>{
       const color={2:"#dc2626",3:"#ea580c",4:"#ca8a04",5:"#2563eb",6:"#16a34a"}[g]||"#64748b";
       return `<span class="grade" style="background:${color}">${g}</span>`;
     }).join(" ");
     const rHtml = rs.join("<br>")||"-";
     const pHtml = ps.join("<br>")||"-";
     return `<td>–û—Ü: ${gHtml}<br>–ó: ${rHtml}<br>–ü: ${pHtml}</td>`;
   }).join("")+"</tr>";
 }).join("");
}

showSection('auth');
</script>

</body>
</html>
