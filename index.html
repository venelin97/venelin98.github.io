<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</title>
<style>
body{margin:0;font-family:Arial;background:#f2f4f7;}
header{background:#2c3e50;color:white;padding:15px;text-align:center;font-size:22px;}
nav{display:flex;flex-wrap:wrap;background:#34495e;}
nav button{flex:1;padding:12px;background:none;border:none;color:white;cursor:pointer;font-size:16px;}
nav button:hover{background:#2c3e50;}
.hidden{display:none;}
.container{padding:15px;}
.card{background:white;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
input,select,textarea,button{width:100%;padding:8px;margin:6px 0;border-radius:5px;border:1px solid #ccc;}
button.action{background:#3498db;color:white;border:none;cursor:pointer;padding:10px;}
button.action:hover{background:#2980b9;}
.table-wrap{overflow-x:auto;}
table{border-collapse:collapse;width:100%;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#3498db;color:white;}
.grade{display:inline-block;padding:4px 7px;border-radius:5px;color:white;font-weight:bold;margin:2px;cursor:pointer;}
</style>
</head>
<body>

<header>üìò –ï–ª–µ–∫—Ç—Ä–æ–Ω–µ–Ω —É—á–∏–ª–∏—â–µ–Ω –¥–Ω–µ–≤–Ω–∏–∫</header>

<nav>
<button onclick="showSection('students')">–£—á–µ–Ω–∏—Ü–∏</button>
<button onclick="showSection('input')">–í—ä–≤–µ–∂–¥–∞–Ω–µ</button>
<button onclick="showSection('diary')">–î–Ω–µ–≤–Ω–∏–∫</button>
<button onclick="showSection('program')">–ü—Ä–æ–≥—Ä–∞–º–∞</button>
<button onclick="logout()">–ò–∑—Ö–æ–¥</button>
</nav>

<div class="container">

<!-- LOGIN / REGISTER -->
<div id="authSection" class="card">
  <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –í—Ö–æ–¥</h3>
  <input id="authEmail" placeholder="–ò–º–µ–π–ª" type="email">
  <input id="authPass" placeholder="–ü–∞—Ä–æ–ª–∞" type="password">
  <button class="action" onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button class="action" onclick="loginUser()">–í—Ö–æ–¥</button>
</div>

<!-- –£–ß–ï–ù–ò–¶–ò -->
<div id="students" class="card hidden">
  <h3>–î–æ–±–∞–≤–∏ —É—á–µ–Ω–∏–∫</h3>
  <input id="newStudent" placeholder="–ò–º–µ –Ω–∞ —É—á–µ–Ω–∏–∫">
  <button class="action" onclick="addStudent()">–î–æ–±–∞–≤–∏</button>
  <div id="studentList"></div>
</div>

<!-- –í–™–í–ï–ñ–î–ê–ù–ï -->
<div id="input" class="card hidden">
  <h3>–í—ä–≤–µ–∂–¥–∞–Ω–µ</h3>
  <select id="entryType">
    <option value="grade">–û—Ü–µ–Ω–∫–∞</option>
    <option value="remark">–ó–∞–±–µ–ª–µ–∂–∫–∞</option>
    <option value="praise">–ü–æ—Ö–≤–∞–ª–∞</option>
  </select>
  <input id="entryStudent" placeholder="–£—á–µ–Ω–∏–∫">
  <select id="entrySubject"></select>

  <div id="gradeBox">
    <input id="gradeValue" type="number" placeholder="–û—Ü–µ–Ω–∫–∞ (2-6)">
    <input id="gradeAuthor" placeholder="–û—Ç –∫–æ–≥–æ">
    <input id="gradeReason" placeholder="–û—Å–Ω–æ–≤–∞–Ω–∏–µ">
  </div>

  <textarea id="textValue" class="hidden" placeholder="–¢–µ–∫—Å—Ç"></textarea>

  <button class="action" onclick="addEntry()">–ó–∞–ø–∞–∑–∏</button>
</div>

<!-- –î–ù–ï–í–ù–ò–ö -->
<div id="diary" class="card hidden">
  <h3>–î–Ω–µ–≤–Ω–∏–∫</h3>
  <div class="table-wrap">
    <table>
      <thead id="diaryHead"></thead>
      <tbody id="diaryBody"></tbody>
    </table>
  </div>
</div>

<!-- –ü–†–û–ì–†–ê–ú–ê -->
<div id="program" class="card hidden">
  <h3>–°–µ–¥–º–∏—á–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞</h3>
  <input id="subjectName" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
  <input id="subjectHours" type="number" placeholder="–ß–∞—Å–æ–≤–µ —Å–µ–¥–º–∏—á–Ω–æ">
  <button class="action" onclick="addSubject()">–î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ø—Ä–µ–¥–º–µ—Ç</button>

  <table>
    <thead><tr><th>–ß–∞—Å</th><th>–î–µ–Ω 1</th><th>–î–µ–Ω 2</th><th>–î–µ–Ω 3</th></tr></thead>
    <tbody id="programTable"></tbody>
  </table>
</div>

</div>

<!-- Firebase Modular SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

// ---------- FIREBASE CONFIG ----------
 const firebaseConfig = {
    apiKey: "AIzaSyDHYqfKhUfIYaB1IYoTGwzqSR4OSO49daw",
    authDomain: "dnevnik2-42909.firebaseapp.com",
    databaseURL: "https://dnevnik2-42909-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "dnevnik2-42909",
    storageBucket: "dnevnik2-42909.firebasestorage.app",
    messagingSenderId: "824393263608",
    appId: "1:824393263608:web:eb35cff1cab09a16eace0d"
  };

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase(app);

let currentUid = null;
let students = {};
let subjects = [];
let program = [];

// ---------- SHOW SECTION ----------
function showSection(id){
  if(id !== 'authSection' && !currentUid) return alert("–ú–æ–ª—è, –≤–ª–µ–∑—Ç–µ!");
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  updateSubjectSelect();
  renderDiary();
  renderProgram();
  updateStudentList();
}

// ---------- AUTH ----------
window.registerUser = function(){
  let email = document.getElementById('authEmail').value.trim();
  let pass  = document.getElementById('authPass').value.trim();
  if(!email || !pass) return alert("–ü–æ–ø—ä–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª–∞");

  createUserWithEmailAndPassword(auth, email, pass)
    .then((userCredential) => {
      currentUid = userCredential.user.uid;
      students = {};
      subjects = [];
      program = [];
      set(ref(db, "diary/" + currentUid), {students, subjects, program})
        .then(()=> { alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!"); loginAfter(currentUid); });
    })
    .catch(err => alert(err.message));
};

window.loginUser = function(){
  let email = document.getElementById('authEmail').value.trim();
  let pass  = document.getElementById('authPass').value.trim();
  if(!email || !pass) return alert("–ü–æ–ø—ä–ª–Ω–∏ email –∏ –ø–∞—Ä–æ–ª–∞");

  signInWithEmailAndPassword(auth, email, pass)
    .then((userCredential) => { loginAfter(userCredential.user.uid); })
    .catch(err => {
      if(err.code === "auth/user-not-found"){
        registerUser();
      } else alert(err.message);
    });
};

function loginAfter(uid){
  currentUid = uid;
  document.getElementById('authSection').classList.add('hidden');
  showSection('students');
  loadData();
}

window.logout = function(){
  signOut(auth).then(()=> location.reload());
};

// ---------- LOAD / SAVE ----------
function loadData(){
  get(child(ref(db), "diary/"+currentUid)).then((snapshot)=>{
    if(snapshot.exists()){
      let val = snapshot.val();
      students = val.students||{};
      subjects = val.subjects||[];
      program  = val.program||[];
    } else {
      students = {};
      subjects = [];
      program  = [];
      set(ref(db, "diary/"+currentUid), {students, subjects, program});
    }
    updateSubjectSelect();
    renderDiary();
    renderProgram();
    updateStudentList();
  });
}

function saveData(){
  if(!currentUid) return;
  set(ref(db,"diary/"+currentUid), {students, subjects, program});
}

// ---------- STUDENTS ----------
window.addStudent = function(){
  let n = document.getElementById('newStudent').value.trim();
  if(!n) return alert("–ù–µ–≤–∞–ª–∏–¥–Ω–æ –∏–º–µ");
  if(!students[n]) students[n]={};
  subjects.forEach(s=> students[n][s.name]={grades:[], remarks:[], praises:[]});
  document.getElementById('newStudent').value="";
  saveData();
  renderDiary();
  updateStudentList();
};

function updateStudentList(){
  let studentList = document.getElementById('studentList');
  studentList.innerHTML="";
  for(let st in students){
    let div = document.createElement("div");
    div.textContent=st;
    let btn = document.createElement("button");
    btn.textContent="–ü—Ä–µ–º–∞—Ö–Ω–∏";
    btn.onclick=()=>{delete students[st]; saveData(); renderDiary(); updateStudentList();}
    div.appendChild(btn);
    studentList.appendChild(div);
  }
}

// ---------- SUBJECTS ----------
window.addSubject = function(){
  let n = document.getElementById('subjectName').value.trim();
  let h = +document.getElementById('subjectHours').value;
  if(!n || !h) return alert("–ü–æ–ø—ä–ª–Ω–∏ –ø—Ä–µ–¥–º–µ—Ç –∏ —á–∞—Å–æ–≤–µ");

  let exists = subjects.find(s=>s.name===n);
  if(exists) { exists.hours = h; }
  else { subjects.push({name:n,hours:h}); }

  for(let st in students){
    if(!students[st][n]) students[st][n]={grades:[], remarks:[], praises:[]};
  }
  document.getElementById('subjectName').value="";
  document.getElementById('subjectHours').value="";
  saveData();
  updateSubjectSelect();
  renderDiary();
};

// ---------- SUBJECT SELECT ----------
function updateSubjectSelect(){
  let sel = document.getElementById('entrySubject');
  sel.innerHTML = subjects.map(s=>`<option>${s.name}</option>`).join("");
}

// ---------- INPUT ----------
document.getElementById('entryType').onchange=()=>{
  document.getElementById('gradeBox').classList.toggle("hidden", document.getElementById('entryType').value!=="grade");
  document.getElementById('textValue').classList.toggle("hidden", document.getElementById('entryType').value==="grade");
};

window.addEntry = function(){
  let st = document.getElementById('entryStudent').value.trim();
  let sub = document.getElementById('entrySubject').value;
  if(!students[st]) return alert("–ù—è–º–∞ —Ç–∞–∫—ä–≤ —É—á–µ–Ω–∏–∫");
  let box = students[st][sub];

  if(document.getElementById('entryType').value==="grade"){
    box.grades.push({
      value:+document.getElementById('gradeValue').value,
      author:document.getElementById('gradeAuthor').value,
      reason:document.getElementById('gradeReason').value
    });
  } else if(document.getElementById('entryType').value==="remark"){
    box.remarks.push(document.getElementById('textValue').value);
  } else {
    box.praises.push(document.getElementById('textValue').value);
  }

  document.getElementById('gradeValue').value="";
  document.getElementById('gradeAuthor').value="";
  document.getElementById('gradeReason').value="";
  document.getElementById('textValue').value="";
  saveData();
  renderDiary();
};

// ---------- DIARY ----------
function gradeColor(v){return {2:"#c0392b",3:"#e67e22",4:"#f1c40f",5:"#3498db",6:"#2ecc71"}[v]||"#777";}

function renderDiary(){
  let diaryHead = document.getElementById('diaryHead');
  let diaryBody = document.getElementById('diaryBody');
  if(!subjects.length){ diaryHead.innerHTML=""; diaryBody.innerHTML=""; return; }

  let h="<tr><th>–£—á–µ–Ω–∏–∫</th>";
  subjects.forEach(s=>h+=`<th>${s.name}</th>`);
  h+="</tr>";
  diaryHead.innerHTML = h;

  let b="";
  for(let st in students){
    b+=`<tr><td>${st}</td>`;
    subjects.forEach(s=>{
      let d = students[st][s.name];
      let gradesHTML = d.grades.map(g=>`<span class="grade" style="background:${gradeColor(g.value)}">${g.value}</span>`).join("");
      let remarksHTML = d.remarks.join("<br>")||"-";
      let praisesHTML = d.praises.join("<br>")||"-";
      b+=`<td>–û—Ü: ${gradesHTML}<br>–ó: ${remarksHTML}<br>–ü: ${praisesHTML}</td>`;
    });
    b+="</tr>";
  }
  diaryBody.innerHTML=b;
}

// ---------- INIT ----------
showSection('authSection');

</script>
</body>
</html>



